---
title: "Figure 3"
subtitle: "Clustering Autism"
author: "Antoine Beauchamp"
date: "2023-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Initialization

```{r packages}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(grid))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(pheatmap))
suppressPackageStartupMessages(library(ggplotify))
suppressPackageStartupMessages(library(RColorBrewer))
# suppressPackageStartupMessages(library(RMINC))
# suppressPackageStartupMessages(library(MRIcrotome))
# suppressPackageStartupMessages(library(patchwork))
# suppressPackageStartupMessages(library(viridis))
# suppressPackageStartupMessages(library(viridisLite))
```

```{r functions}
source("../src/utils.R")
# source("../src/processing.R")
# source("../src/analysis.R")
```

```{r pipeline-params}
# Output directory
output_dir <- "figure3/"

# Plot file prefix
output_plot_prefix <- "fig3_v1"

# Similarity pipeline
version <- "v2"
pipeline_dir <- "../data/cross_species/"
pipeline_dir <- file.path(pipeline_dir, version)

# Human parameters
human_resolution <- 0.8
human_es_method <- "normative-growth"
human_es_df <- 3
human_cluster_map_method <- "mean"

# Mouse parameters
mouse_resolution <- 0.2
mouse_cluster_map_method <- human_cluster_map_method

# Similarity parameters
metric <- "correlation"

# Fetch parameter set
metadata <- file.path(pipeline_dir, "metadata.csv")
params <- fetch_params_metadata(metadata = metadata,
                                human_resolution = human_resolution,
                                human_es_method = human_es_method,
                                human_es_df = human_es_df,
                                human_cluster_map_method = human_cluster_map_method,
                                metric = metric)
params
```

```{r paths}
# Parameter set ID
params_id <- 405

# Update pipeline directory with parameter set ID
pipeline_dir <- file.path(pipeline_dir, params_id)

# Max number of clusters
nk_max <- params %>% 
  filter(id == params_id) %>% 
  pull(human_cluster_nk_max)

# # Jacobians
# jacobians <- c("absolute", "relative")
# 
# # Human parameter set ID
# human_params_id <- params %>% 
#   filter(id == params_id) %>% 
#   pull(human_id)
# 
# # Mouse parameter set ID
# mouse_params_id <- params %>% 
#   filter(id == params_id) %>% 
#   pull(mouse_id)
# 
# # Human pipeline directory
# human_pipeline_dir <- "../data/human/derivatives/"
# human_pipeline_dir <- file.path(human_pipeline_dir, version, human_params_id)
# 
# # Human cluster map directories
# human_cluster_map_dirs <- file.path(human_pipeline_dir, "cluster_maps")
# human_cluster_map_dirs <- file.path(human_cluster_map_dirs, str_c("resolution_", human_resolution))
# human_cluster_map_dirs <- file.path(human_cluster_map_dirs, jacobians)
# names(human_cluster_map_dirs) <- jacobians
# 
# # Mouse pipeline directory
# mouse_pipeline_dir <- "../data/mouse/derivatives/"
# mouse_pipeline_dir <- file.path(mouse_pipeline_dir, "v2", mouse_params_id)
# 
# # Mouse cluster map directories
# mouse_cluster_map_dirs <- file.path(mouse_pipeline_dir, "cluster_maps")
# mouse_cluster_map_dirs <- file.path(mouse_cluster_map_dirs, str_c("resolution_", mouse_resolution))
# mouse_cluster_map_dirs <- file.path(mouse_cluster_map_dirs, jacobians)
# names(mouse_cluster_map_dirs) <- jacobians
# 
# mouse_cluster_map_dirs_50um <- file.path(mouse_pipeline_dir, "cluster_maps")
# mouse_cluster_map_dirs_50um <- file.path(mouse_cluster_map_dirs_50um, "resolution_0.05")
# mouse_cluster_map_dirs_50um <- file.path(mouse_cluster_map_dirs_50um, jacobians)
# names(mouse_cluster_map_dirs_50um) <- jacobians
```

```{r graphical-params}
# Number of bigpts in an inch
pt_per_in <- 72

# Font family
font_family <- "Helvetica"

# Nature suggested font size: 5-7 pt
font_size <- 6

# Empty rectangle grob
empty_rect_grob <- rectGrob(gp = gpar(fill = NA))
```

# Panel: Mouse pathway matrix

```{r fig3-pathways-mouse-import}
# Threshold for StringDB 
stringdb_threshold <- 950

# Base directory for pathway data files
mouse_pathways_dir <- "/projects/jacob/ClusteringAutism_125Models_Mar2020/Data/Outputs/NeighbourhoodEnrichment_Paper/"
mouse_pathways_dir <- file.path(mouse_pathways_dir, stringdb_threshold)

# Prefix for pathway data files
mouse_pathways_file_prefix <- "NewBader_enrichment_clusterneighbourhood_vs_brain_all"

# Pathway IDs for a prior pathway set
pathway_ids <-c("GAP JUNCTION TRAFFICKING AND REGULATION%REACTOME%R-HSA-157858.1",
                "TRANSMISSION ACROSS CHEMICAL SYNAPSES%REACTOME%R-HSA-112315.5",
                "PROTEIN-PROTEIN INTERACTIONS AT SYNAPSES%REACTOME DATABASE ID RELEASE 71%6794362",
                "ADHERENS JUNCTIONS INTERACTIONS%REACTOME%R-HSA-418990.2",
                "TIGHT JUNCTION INTERACTIONS%REACTOME DATABASE ID RELEASE 71%420029",
                "MAPK FAMILY SIGNALING CASCADES%REACTOME DATABASE ID RELEASE 71%5683057",
                "SIGNALING BY ERBB2%REACTOME DATABASE ID RELEASE 71%1227986",
                "SIGNALING BY ERBB4%REACTOME DATABASE ID RELEASE 71%1236394",
                "SIGNALING BY WNT%REACTOME%R-HSA-195721.5",
                "CA2+ PATHWAY%REACTOME DATABASE ID RELEASE 71%4086398",
                "SIGNALING BY NOTCH%REACTOME DATABASE ID RELEASE 71%157118",
                "MTOR SIGNALLING%REACTOME%R-HSA-165159.5",
                "SIGNALING BY VEGF%REACTOME DATABASE ID RELEASE 71%194138",
                "SIGNALING BY HEDGEHOG%REACTOME DATABASE ID RELEASE 71%5358351",
                "AXON GUIDANCE%REACTOME DATABASE ID RELEASE 71%422475",
                "CHROMATIN ORGANIZATION%REACTOME DATABASE ID RELEASE 71%4839726",
                "GENERIC TRANSCRIPTION PATHWAY%REACTOME%R-HSA-212436.9",
                "GENE EXPRESSION (TRANSCRIPTION)%REACTOME DATABASE ID RELEASE 71%74160",
                "LONG-TERM POTENTIATION%REACTOME DATABASE ID RELEASE 71%9620244",
                "SIGNALING BY GPCR%REACTOME%R-HSA-372790.4")

# Import mouse pathway enrichment files
# Iterate over cluster solutions
list_mouse_pathways <- vector(mode = "list", length = nk_max-1)
names(list_mouse_pathways) <- 2:nk_max
for (nk in 2:nk_max) {
  
  # Iterate over cluster number
  list_mouse_pathways[[as.character(nk)]] <- vector(mode = "list", length = nk)
  for (k in 1:nk) {
    pathways_file <- paste(mouse_pathways_file_prefix, nk, k, stringdb_threshold, sep = "_")
    pathways_file <- paste0(pathways_file, ".csv")
    pathways_file <- file.path(mouse_pathways_dir, pathways_file)
    list_mouse_pathways[[as.character(nk)]][[k]] <- read_csv(pathways_file, show_col_types = FALSE)  
    
    # Fix mouse enrichment p-values and q-values
    # REMOVE IF FIXED UPSTREAM
    list_mouse_pathways[[as.character(nk)]][[k]] <- list_mouse_pathways[[as.character(nk)]][[k]] %>% 
      mutate(P.Value = P.Value/2,
             adj.P.Val = p.adjust(P.Value, method = "fdr"),
             NLQ = -log10(adj.P.Val))
  }
  
  # Combine clusters per solution
  list_mouse_pathways[[as.character(nk)]] <- list_mouse_pathways[[as.character(nk)]] %>% 
    reduce(.f = bind_rows) %>% 
    rename(pathway = Title,
           k = cluster) %>% 
    filter(ID %in% pathway_ids) %>% 
    mutate(nk = nk) %>% 
    unite(col = "cluster_id", nk, k, 
          sep = "-", remove = FALSE)
  
}
```

```{r}
# Reduce all pathway data frames into one
df_mouse_pathways_all <- bind_rows(list_mouse_pathways)

# Filter for cluster solutions with nk >= 4
df_mouse_pathways_nk_gt4 <- df_mouse_pathways_all %>% 
  filter(nk >= 4)

# Cluster order 
cluster_lvls <- df_mouse_pathways_nk_gt4 %>% 
  select(nk, k, cluster_id) %>% 
  distinct() %>% 
  arrange(nk, k) %>% 
  pull(cluster_id)

# List of desired pathway terms
pathway_terms <- c("Chromatin organization",
                   "Gene expression (transcription)",
                   "Generic transcription pathway",
                   "Mapk family signaling cascades",
                   "Mtor signalling",
                   "Protein-protein interactions at synapses",
                   "Signaling by hedgehog",
                   "Signaling by notch",
                   "Signaling by wnt",
                   "Transmission across chemical synapses")

# Filter for desired pathways
# Compute normalized enrichment per pathway
df_mouse_pathways_nk_gt4 <- df_mouse_pathways_nk_gt4 %>% 
  filter(pathway %in% pathway_terms) %>% 
  mutate(cluster_id = factor(cluster_id, levels = cluster_lvls),
         pathway = factor(pathway, levels = pathway_terms)) %>% 
  group_by(pathway) %>% 
  mutate(E_norm = E/max(E)) %>% 
  ungroup()

# Convert pathway data frame into matrix 
mat_mouse_pathways_nk_gt4 <- df_mouse_pathways_nk_gt4 %>% 
  select(pathway, cluster_id, E_norm) %>% 
  pivot_wider(id_cols = pathway, names_from = cluster_id, values_from = E_norm) %>% 
  column_to_rownames("pathway") %>% 
  as.matrix()
```

```{r}
# Generate clustered heatmap
pheatmap_out <- pheatmap(mat = mat_mouse_pathways_nk_gt4,
                         cluster_col = FALSE,
                         cluster_rows = TRUE,
                         clustering_distance_rows = "euclidean",
                         cutree_rows = 4, 
                         silent = TRUE)

# Extract pathway clustering outputs
pheatmap_pathway_lvls <- pheatmap_out[["tree_row"]][["labels"]]
pheatmap_pathway_order <- pheatmap_out[["tree_row"]][["order"]]
pathway_lvls_clustered <- pheatmap_pathway_lvls[pheatmap_pathway_order]

# Level at which to cut the dendrogram
hclust_kcut <- 4

# Obtain pathway cluster order at selected solution
df_pathway_hclust <- cutree(pheatmap_out[["tree_row"]], k = hclust_kcut) %>% 
  enframe(name = "pathway", value = "pathway_cluster") 

# Relevel pathways to follow dendrogram order
df_pathway_cluster_lvls <- df_pathway_hclust %>% 
  mutate(pathway = factor(pathway, levels = pathway_lvls_clustered)) %>% 
  arrange(pathway) %>% 
  select(pathway_cluster) %>% 
  distinct() %>% 
  mutate(pathway_cluster_new = 1:nrow(.))

df_pathway_hclust <- df_pathway_hclust %>% 
  left_join(df_pathway_cluster_lvls, by = "pathway_cluster") %>% 
  select(-pathway_cluster, pathway_cluster = pathway_cluster_new)
```

```{r}
# Join pathway enrichment information with pathway clusters
df_mouse_pathways_heatmap <- df_mouse_pathways_nk_gt4 %>% 
  left_join(df_pathway_hclust, by = "pathway") %>% 
  mutate(pathway = factor(pathway, levels = pathway_lvls_clustered)) 

# Clamped enrichment
E_threshold <- 30
df_mouse_pathways_heatmap <- df_mouse_pathways_heatmap %>% 
  mutate(E_clamped = ifelse(E > E_threshold, E_threshold, E))

# Heatmap palette
heatmap_palette_cols <- c("white", brewer.pal(n = 9, name = "OrRd")[3:9])
heatmap_palette <- colorRampPalette(colors = heatmap_palette_cols)(255)

# Generate heatmap
fig3_mouse_pathways_heatmap <- ggplot(df_mouse_pathways_heatmap, 
                                      aes(x = cluster_id, 
                                          y = fct_rev(pathway), 
                                          fill = E_clamped)) + 
  geom_tile(col = "grey60") +
  facet_grid(pathway_cluster~nk, scales = "free", space = "free") + 
  scale_x_discrete(expand = expansion()) + 
  scale_y_discrete(expand = expansion(), position = "right") + 
  scale_fill_gradientn(colors = heatmap_palette) +
  labs(x = "Mouse cluster",
       y = "Biological pathway module",
       fill = "Enrichment") +
  theme_bw() +
  theme(strip.background.y = element_blank(),
        strip.text.y = element_blank(),
        strip.background.x = element_rect(fill = "grey90"))

# fig3_mouse_pathways_heatmap_width_pt <- 
# fig3_mouse_pathways_heatmap_height_pt <- 

# fig3_mouse_pathways_heatmap_width_in <- fig3_mouse_pathways_heatmap_width_pt/pt_per_in
# fig3_mouse_pathways_heatmap_height_in <- fig3_mouse_pathways_heatmap_height_pt/pt_per_in

fig3_mouse_pathways_heatmap_width_in <- 12
fig3_mouse_pathways_heatmap_height_in <- 4

fig3_mouse_pathways_heatmap_width_in <- unit(fig3_mouse_pathways_heatmap_width_in, "in")
fig3_mouse_pathways_heatmap_height_in <- unit(fig3_mouse_pathways_heatmap_height_in, "in")

# Export plot
outfile <- paste(output_plot_prefix, "mouse_pathways_heatmap", sep = "_")
outfile <- paste0(outfile, ".pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = fig3_mouse_pathways_heatmap_width_in,
    height = fig3_mouse_pathways_heatmap_height_in)
print(fig3_mouse_pathways_heatmap)
dev.off()
```

```{r}
test <- fig3_mouse_pathways_heatmap
test_grob <- ggplotGrob(test)
class(test_grob)
test_grob$
  ```

```{r}
pheatmap_out$gtable
```

```{r}
grid.newpage()
grid.draw(pheatmap_out$gtable$grobs[[1]])
```

```{r}
grid.newpage()
grid.draw(pheatmap_out$gtable$grobs[[2]])
```

```{r}
pheatmap_out$gtable$grobs[[2]]$children$GRID.rect.490$y[1]
```
```{r}
dim(mat_mouse_pathways_nk_gt4)
```

