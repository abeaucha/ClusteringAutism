---
title: "Figure 4"
subtitle: "Clustering Autism"
author: "Antoine Beauchamp"
date: "2024-07-22"
output: html_document
---

# Initialization

```{r fig2-knitr-setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r fig2-packages}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(RMINC))
suppressPackageStartupMessages(library(MRIcrotome))
# suppressPackageStartupMessages(library(grid))
# suppressPackageStartupMessages(library(gridExtra))
# suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(viridisLite))
# suppressPackageStartupMessages(library(RColorBrewer))
# suppressPackageStartupMessages(library(rcartocolor))
# suppressPackageStartupMessages(library(pROC))
```

```{r fig2-environment}
SRCPATH <- Sys.getenv("SRCPATH")
PROJECTPATH <- Sys.getenv("PROJECTPATH")
```

```{r fig2-functions}
source(file.path(SRCPATH, "utils.R"))
source(file.path(SRCPATH, "processing.R"))
source(file.path(SRCPATH, "analysis.R"))
```

```{r fig2-pipeline-params}
# Output directory
output_dir <- "figure4/"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
}

# Plot file prefix
output_plot_prefix <- "figure4"

# Similarity pipeline
version <- "v3"
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species")
pipeline_dir <- file.path(pipeline_dir, version)

# Human parameters
human_dataset <- "POND-SickKids"
human_resolution <- 0.8
human_es_method <- "normative-growth"
human_es_df <- 3
human_centroid_method <- "mean"

# Mouse parameters
mouse_resolution <- 0.2

# Similarity parameters
metric <- "correlation"

# Fetch parameter set
metadata <- file.path(pipeline_dir, "metadata.csv")
params <- fetch_params_metadata(metadata = metadata,
                                input_1_species = "human",
                                input_1_id = "700",
                                input_2_species = "mouse",
                                input_2_id = "107",
                                n_latent_spaces = 50,
                                metric = metric)
params
```

```{r fig2-paths}
# Parameter set ID
params_id <- 375

# Update pipeline directory with parameter set ID
pipeline_dir <- file.path(pipeline_dir, params_id)

# Jacobians
jacobians <- c("absolute", "relative")

# Extract parameter set
params_subset <- params %>% 
  filter(id == params_id)

# Human parameter set ID
human_params_id <- params_subset[["input_1_id"]] 
mouse_params_id <- params_subset[["input_2_id"]] 

# Human pipeline directory
human_pipeline_dir <- file.path(PROJECTPATH, "data/human/derivatives/", version)
human_metadata <- file.path(human_pipeline_dir, "metadata.csv")
human_params <- fetch_params_metadata(metadata = human_metadata, 
                                      id = human_params_id)
human_pipeline_dir <- file.path(human_pipeline_dir, human_params_id)

# Human image resolution
human_resolution <- human_params[["resolution"]]

# Human cluster map directories
human_centroid_dirs <- file.path(human_pipeline_dir, "centroids")
human_centroid_dirs <- file.path(human_centroid_dirs, str_c("resolution_", human_resolution))
human_centroid_dirs <- file.path(human_centroid_dirs, jacobians)
names(human_centroid_dirs) <- jacobians

# Mouse pipeline directory
mouse_pipeline_dir <- file.path(PROJECTPATH, "data/mouse/derivatives/", version)
mouse_metadata <- file.path(mouse_pipeline_dir, "metadata.csv")
mouse_params <- fetch_params_metadata(metadata = mouse_metadata,
                                      id = as.numeric(mouse_params_id))
mouse_pipeline_dir <- file.path(mouse_pipeline_dir, mouse_params_id)

# Mouse image resolution 
mouse_resolution <- mouse_params[["resolution"]]

# Mouse centroid directories
mouse_centroid_dirs <- file.path(mouse_pipeline_dir, "centroids")
mouse_centroid_dirs <- file.path(mouse_centroid_dirs, str_c("resolution_", mouse_resolution))
mouse_centroid_dirs <- file.path(mouse_centroid_dirs, jacobians)
names(mouse_centroid_dirs) <- jacobians

# Mouse cluster map directories at 50um
mouse_centroid_dirs_50um <- file.path(mouse_pipeline_dir, "centroids")
mouse_centroid_dirs_50um <- file.path(mouse_centroid_dirs_50um, "resolution_0.05")
mouse_centroid_dirs_50um <- file.path(mouse_centroid_dirs_50um, jacobians)
names(mouse_centroid_dirs_50um) <- jacobians

# Max number of clusters
nk_max <- human_params[["cluster_nk_max"]]
```

```{r fig2-graphical-params}
# # Number of bigpts in an inch
# pt_per_in <- 72
# 
# # Font family
# font_family <- "Helvetica"
# 
# # Nature suggested font size: 5-7 pt
# font_size <- 6
# 
# # Empty rectangle grob
# empty_rect_grob <- rectGrob(gp = gpar(fill = NA))
# 
# # Black rectangle grob
# black_rect_grob <- rectGrob(gp = gpar(fill = "black"))
# 
# # Rectangle with number in it
# rect_w_num <- function(n) {
#   out <- gTree(children = gList(empty_rect_grob,
#                                 textGrob(label = n)))
#   return(out)
# }
# 
# # Maximal figure dimensions in bigpts
# fig2_width_pt <- 510
# fig2_height_pt <- 481
```


# PONDSK-MICe

```{r fig4-PONDSK-MICe-heatmap}
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species/v3/375/")

# Cluster solutions to visualize
nk_1 <- 2
nk_2 <- 4


# Import similarity ----------------------------------------------------------

# Path to mouse-human similarity directory
similarity_dir <- file.path(pipeline_dir, "similarity")
similarity_file <- file.path(similarity_dir, "similarity.csv")

# Import the similarity data and extract cluster information
similarity <- read_csv(similarity_file, show_col_types = FALSE) %>% 
  mutate(img1_nk = img1 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_k = img1 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_jacobians = img1 %>% 
           str_extract("absolute|relative"),
         img2_nk = img2 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_k = img2 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_jacobians = img2 %>% 
           str_extract("absolute|relative"),) %>% 
  unite(col = "img1_cluster_id", img1_nk, img1_k, 
        sep = "-", remove = FALSE) %>% 
  unite(col = "img2_cluster_id", img2_nk, img2_k, 
        sep = "-", remove = FALSE)

# Filter similarity data for desired cluster numbers
# and combine Jacobians
df_similarity_nk <- similarity %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity),
            .groups = "drop")


# Import permutations --------------------------------------------------------

# Path to permutations directory
permutation_dir <- file.path(pipeline_dir, "permutations", "similarity")

# Permutation file names
permutation_files <- list.files(permutation_dir)

# Number of permutations
np <- length(permutation_files)
list_permutations <- vector(mode = "list", length = np)  
for (p in 1:np) {
  
  # Permutation data to import
  permutation_file <- permutation_files %>% 
    str_subset(str_c("similarity_permutation_", p, ".csv"))
  permutation_file <- file.path(permutation_dir, permutation_file)
  
  # Import permutation data
  list_permutations[[p]] <- read_csv(permutation_file, 
                                     show_col_types = FALSE) %>% 
    mutate(img1_nk = img1 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img1_k = img1 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_nk = img2 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_k = img2 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric()) %>% 
    unite(col = "img1_cluster_id", img1_nk, img1_k, 
          sep = "-", remove = FALSE) %>% 
    unite(col = "img2_cluster_id", img2_nk, img2_k, 
          sep = "-", remove = FALSE) %>% 
    mutate(permutation = p)
  
}
 
# Filter permutations data for desired cluster numbers
# and combine Jacobians
df_permutations_nk <- list_permutations %>% 
  bind_rows() %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(permutation, img1_nk, img2_nk, img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity), .groups = "drop")


# Compute p-values -----------------------------------------------------------

# Compute p-values for cluster correlations
df_similarity_nk[["pval"]] <- 0
for (i in 1:nrow(df_similarity_nk)) {
  df_similarity_nk[[i, "pval"]] <- sum(df_permutations_nk[["similarity"]] >= df_similarity_nk[[i, "similarity"]])/nrow(df_permutations_nk)
}

# Compute q-values and -log10 transforms
df_similarity_nk <- df_similarity_nk %>% 
  mutate(qval = p.adjust(pval, method = "fdr"),
         pval_log = -log10(pval),
         qval_log = -log10(qval),
         significant = ifelse(pval < 0.05, TRUE, FALSE),
         pval_lab = ifelse(significant, "*", ""))


# Generate heatmap -----------------------------------------------------------

# Max and min similarity values
similarity_max <- max(df_similarity_nk[["similarity"]])
similarity_min <- min(df_similarity_nk[["similarity"]])

# Length of the heatmap palette
heatmap_palette_length <- 255

# Numerical values for the heatmap scale
heatmap_scale_values <- seq(similarity_min, similarity_max, length.out = heatmap_palette_length)
heatmap_scale_values <- (heatmap_scale_values - similarity_min)/(similarity_max - similarity_min)

# Colours for the heatmap palette 
heatmap_scale_colours <- magma(n = heatmap_palette_length, begin = 0.3)

# Heatmap palette vector
heatmap_scale_palette <- colorRampPalette(heatmap_scale_colours)(heatmap_palette_length)

# Clamp log p-values when infinite
df_similarity_nk <- df_similarity_nk %>% 
  mutate(pval_log = ifelse(is.infinite(pval_log), 3, pval_log))

# Heatmap plot
fig2_sim_heatmap <- ggplot(df_similarity_nk, 
                           aes(x = img2_cluster_id, 
                               y = fct_rev(img1_cluster_id), 
                               fill = similarity)) + 
  geom_tile(col = "grey50") + 
  geom_text(mapping = aes(label = pval_lab),
            size = 6, 
            hjust = "center", 
            vjust = "center",
            nudge_y = -0.12) + 
  labs(x = "Mouse clusters",
       y = "Human clusters",
       fill = "Correlation") + 
  scale_fill_gradientn(colors = heatmap_scale_palette,
                       values = heatmap_scale_values,
                       breaks = seq(0, 1, by = 0.1),
                       guide = guide_colourbar(title.position = "top",
                                               barheight = unit(60, "bigpts"),
                                               barwidth = unit(15, "bigpts"))) +
  scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
  scale_y_discrete(expand = expansion(mult = 0)) + 
  theme_bw() +
  theme(plot.margin = margin(t = 0, b = 0, l = 5, unit = "bigpts"),
        legend.position = c(1, 0),
        legend.justification = c("left", "bottom"))

# Export
outfile <- paste0("figure4_PONDSK_MICe_heatmap.pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(500/72, "in"),
    height = unit(500/72, "in"))
print(fig2_sim_heatmap)
dev.off()
```

```{r}
df_similarity_nk %>% 
  select(img1_cluster_id, img2_cluster_id, similarity, pval)
```


```{r fig4-PONDSK-MICe-nk6-heatmap}
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species/v3/375/")

# Cluster solutions to visualize
nk_1 <- 6
nk_2 <- 6


# Import similarity ----------------------------------------------------------

# Path to mouse-human similarity directory
similarity_dir <- file.path(pipeline_dir, "similarity")
similarity_file <- file.path(similarity_dir, "similarity.csv")

# Import the similarity data and extract cluster information
similarity <- read_csv(similarity_file, show_col_types = FALSE) %>% 
  mutate(img1_nk = img1 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_k = img1 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_jacobians = img1 %>% 
           str_extract("absolute|relative"),
         img2_nk = img2 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_k = img2 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_jacobians = img2 %>% 
           str_extract("absolute|relative"),) %>% 
  unite(col = "img1_cluster_id", img1_nk, img1_k, 
        sep = "-", remove = FALSE) %>% 
  unite(col = "img2_cluster_id", img2_nk, img2_k, 
        sep = "-", remove = FALSE)

# Filter similarity data for desired cluster numbers
# and combine Jacobians
df_similarity_nk <- similarity %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity),
            .groups = "drop")


# Import permutations --------------------------------------------------------

# Path to permutations directory
permutation_dir <- file.path(pipeline_dir, "permutations", "similarity")

# Permutation file names
permutation_files <- list.files(permutation_dir)

# Number of permutations
np <- length(permutation_files)
list_permutations <- vector(mode = "list", length = np)  
for (p in 1:np) {
  
  # Permutation data to import
  permutation_file <- permutation_files %>% 
    str_subset(str_c("similarity_permutation_", p, ".csv"))
  permutation_file <- file.path(permutation_dir, permutation_file)
  
  # Import permutation data
  list_permutations[[p]] <- read_csv(permutation_file, 
                                     show_col_types = FALSE) %>% 
    mutate(img1_nk = img1 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img1_k = img1 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_nk = img2 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_k = img2 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric()) %>% 
    unite(col = "img1_cluster_id", img1_nk, img1_k, 
          sep = "-", remove = FALSE) %>% 
    unite(col = "img2_cluster_id", img2_nk, img2_k, 
          sep = "-", remove = FALSE) %>% 
    mutate(permutation = p)
  
}
 
# Filter permutations data for desired cluster numbers
# and combine Jacobians
df_permutations_nk <- list_permutations %>% 
  bind_rows() %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(permutation, img1_nk, img2_nk, img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity), .groups = "drop")


# Compute p-values -----------------------------------------------------------

# Compute p-values for cluster correlations
df_similarity_nk[["pval"]] <- 0
for (i in 1:nrow(df_similarity_nk)) {
  df_similarity_nk[[i, "pval"]] <- sum(df_permutations_nk[["similarity"]] >= df_similarity_nk[[i, "similarity"]])/nrow(df_permutations_nk)
}

# Compute q-values and -log10 transforms
df_similarity_nk <- df_similarity_nk %>% 
  mutate(qval = p.adjust(pval, method = "fdr"),
         pval_log = -log10(pval),
         qval_log = -log10(qval),
         significant = ifelse(pval < 0.05, TRUE, FALSE),
         pval_lab = ifelse(significant, "*", ""))


# Generate heatmap -----------------------------------------------------------

# Max and min similarity values
similarity_max <- max(df_similarity_nk[["similarity"]])
similarity_min <- min(df_similarity_nk[["similarity"]])

# Length of the heatmap palette
heatmap_palette_length <- 255

# Numerical values for the heatmap scale
heatmap_scale_values <- seq(similarity_min, similarity_max, length.out = heatmap_palette_length)
heatmap_scale_values <- (heatmap_scale_values - similarity_min)/(similarity_max - similarity_min)

# Colours for the heatmap palette 
heatmap_scale_colours <- magma(n = heatmap_palette_length, begin = 0.3)

# Heatmap palette vector
heatmap_scale_palette <- colorRampPalette(heatmap_scale_colours)(heatmap_palette_length)

# Clamp log p-values when infinite
df_similarity_nk <- df_similarity_nk %>% 
  mutate(pval_log = ifelse(is.infinite(pval_log), 3, pval_log))

# Heatmap plot
fig2_sim_heatmap <- ggplot(df_similarity_nk, 
                           aes(x = img2_cluster_id, 
                               y = fct_rev(img1_cluster_id), 
                               fill = similarity)) + 
  geom_tile(col = "grey50") + 
  geom_text(mapping = aes(label = pval_lab),
            size = 6, 
            hjust = "center", 
            vjust = "center",
            nudge_y = -0.12) + 
  labs(x = "Mouse clusters",
       y = "Human clusters",
       fill = "Correlation") + 
  scale_fill_gradientn(colors = heatmap_scale_palette,
                       values = heatmap_scale_values,
                       breaks = seq(0, 1, by = 0.1),
                       guide = guide_colourbar(title.position = "top",
                                               barheight = unit(60, "bigpts"),
                                               barwidth = unit(15, "bigpts"))) +
  scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
  scale_y_discrete(expand = expansion(mult = 0)) + 
  theme_bw() +
  theme(plot.margin = margin(t = 0, b = 0, l = 5, unit = "bigpts"),
        legend.position = c(1, 0),
        legend.justification = c("left", "bottom"))

# Export
outfile <- paste0("figure4_PONDSK_MICe_heatmap_nk6.pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(500/72, "in"),
    height = unit(500/72, "in"))
print(fig2_sim_heatmap)
dev.off()
```




# HBN-MICe


```{r fig4-HBN-MICe-heatmap}
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species/v3/861/")

# Cluster solutions to visualize
nk_1 <- 3
nk_2 <- 4


# Import similarity ----------------------------------------------------------

# Path to mouse-human similarity directory
similarity_dir <- file.path(pipeline_dir, "similarity")
similarity_file <- file.path(similarity_dir, "similarity.csv")

# Import the similarity data and extract cluster information
similarity <- read_csv(similarity_file, show_col_types = FALSE) %>% 
  mutate(img1_nk = img1 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_k = img1 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_jacobians = img1 %>% 
           str_extract("absolute|relative"),
         img2_nk = img2 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_k = img2 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_jacobians = img2 %>% 
           str_extract("absolute|relative"),) %>% 
  unite(col = "img1_cluster_id", img1_nk, img1_k, 
        sep = "-", remove = FALSE) %>% 
  unite(col = "img2_cluster_id", img2_nk, img2_k, 
        sep = "-", remove = FALSE)

# Filter similarity data for desired cluster numbers
# and combine Jacobians
df_similarity_nk <- similarity %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity),
            .groups = "drop")


# Import permutations --------------------------------------------------------

# Path to permutations directory
permutation_dir <- file.path(pipeline_dir, "permutations", "similarity")

# Permutation file names
permutation_files <- list.files(permutation_dir)

# Number of permutations
np <- length(permutation_files)
list_permutations <- vector(mode = "list", length = np)  
for (p in 1:np) {
  
  # Permutation data to import
  permutation_file <- permutation_files %>% 
    str_subset(str_c("similarity_permutation_", p, ".csv"))
  permutation_file <- file.path(permutation_dir, permutation_file)
  
  # Import permutation data
  list_permutations[[p]] <- read_csv(permutation_file, 
                                     show_col_types = FALSE) %>% 
    mutate(img1_nk = img1 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img1_k = img1 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_nk = img2 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_k = img2 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric()) %>% 
    unite(col = "img1_cluster_id", img1_nk, img1_k, 
          sep = "-", remove = FALSE) %>% 
    unite(col = "img2_cluster_id", img2_nk, img2_k, 
          sep = "-", remove = FALSE) %>% 
    mutate(permutation = p)
  
}
 
# Filter permutations data for desired cluster numbers
# and combine Jacobians
df_permutations_nk <- list_permutations %>% 
  bind_rows() %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(permutation, img1_nk, img2_nk, img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity), .groups = "drop")


# Compute p-values -----------------------------------------------------------

# Compute p-values for cluster correlations
df_similarity_nk[["pval"]] <- 0
for (i in 1:nrow(df_similarity_nk)) {
  df_similarity_nk[[i, "pval"]] <- sum(df_permutations_nk[["similarity"]] >= df_similarity_nk[[i, "similarity"]])/nrow(df_permutations_nk)
}

# Compute q-values and -log10 transforms
df_similarity_nk <- df_similarity_nk %>% 
  mutate(qval = p.adjust(pval, method = "fdr"),
         pval_log = -log10(pval),
         qval_log = -log10(qval),
         significant = ifelse(pval < 0.05, TRUE, FALSE),
         pval_lab = ifelse(significant, "*", ""))


# Generate heatmap -----------------------------------------------------------

# Max and min similarity values
similarity_max <- max(df_similarity_nk[["similarity"]])
similarity_min <- min(df_similarity_nk[["similarity"]])

# Length of the heatmap palette
heatmap_palette_length <- 255

# Numerical values for the heatmap scale
heatmap_scale_values <- seq(similarity_min, similarity_max, length.out = heatmap_palette_length)
heatmap_scale_values <- (heatmap_scale_values - similarity_min)/(similarity_max - similarity_min)

# Colours for the heatmap palette 
heatmap_scale_colours <- magma(n = heatmap_palette_length, begin = 0.3)

# Heatmap palette vector
heatmap_scale_palette <- colorRampPalette(heatmap_scale_colours)(heatmap_palette_length)

# Clamp log p-values when infinite
df_similarity_nk <- df_similarity_nk %>% 
  mutate(pval_log = ifelse(is.infinite(pval_log), 3, pval_log))

# Heatmap plot
fig2_sim_heatmap <- ggplot(df_similarity_nk, 
                           aes(x = img2_cluster_id, 
                               y = fct_rev(img1_cluster_id), 
                               fill = similarity)) + 
  geom_tile(col = "grey50") + 
  geom_text(mapping = aes(label = pval_lab),
            size = 6, 
            hjust = "center", 
            vjust = "center",
            nudge_y = -0.12) + 
  labs(x = "Mouse clusters",
       y = "Human clusters",
       fill = "Correlation") + 
  scale_fill_gradientn(colors = heatmap_scale_palette,
                       values = heatmap_scale_values,
                       breaks = seq(0, 1, by = 0.1),
                       guide = guide_colourbar(title.position = "top",
                                               barheight = unit(60, "bigpts"),
                                               barwidth = unit(15, "bigpts"))) +
  scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
  scale_y_discrete(expand = expansion(mult = 0)) + 
  theme_bw() +
  theme(plot.margin = margin(t = 0, b = 0, l = 5, unit = "bigpts"),
        legend.position = c(1, 0),
        legend.justification = c("left", "bottom"))

# Export
outfile <- paste0("figure4_HBN_MICe_heatmap.pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(500/72, "in"),
    height = unit(500/72, "in"))
print(fig2_sim_heatmap)
dev.off()
```

```{r}
df_similarity_nk %>% 
  select(img1_cluster_id, img2_cluster_id, similarity, pval)
```


```{r fig4-HBN-MICe-nk6-heatmap}
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species/v3/861/")

# Cluster solutions to visualize
nk_1 <- 6
nk_2 <- 6


# Import similarity ----------------------------------------------------------

# Path to mouse-human similarity directory
similarity_dir <- file.path(pipeline_dir, "similarity")
similarity_file <- file.path(similarity_dir, "similarity.csv")

# Import the similarity data and extract cluster information
similarity <- read_csv(similarity_file, show_col_types = FALSE) %>% 
  mutate(img1_nk = img1 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_k = img1 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_jacobians = img1 %>% 
           str_extract("absolute|relative"),
         img2_nk = img2 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_k = img2 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_jacobians = img2 %>% 
           str_extract("absolute|relative"),) %>% 
  unite(col = "img1_cluster_id", img1_nk, img1_k, 
        sep = "-", remove = FALSE) %>% 
  unite(col = "img2_cluster_id", img2_nk, img2_k, 
        sep = "-", remove = FALSE)

# Filter similarity data for desired cluster numbers
# and combine Jacobians
df_similarity_nk <- similarity %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity),
            .groups = "drop")


# Import permutations --------------------------------------------------------

# Path to permutations directory
permutation_dir <- file.path(pipeline_dir, "permutations", "similarity")

# Permutation file names
permutation_files <- list.files(permutation_dir)

# Number of permutations
np <- length(permutation_files)
list_permutations <- vector(mode = "list", length = np)  
for (p in 1:np) {
  
  # Permutation data to import
  permutation_file <- permutation_files %>% 
    str_subset(str_c("similarity_permutation_", p, ".csv"))
  permutation_file <- file.path(permutation_dir, permutation_file)
  
  # Import permutation data
  list_permutations[[p]] <- read_csv(permutation_file, 
                                     show_col_types = FALSE) %>% 
    mutate(img1_nk = img1 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img1_k = img1 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_nk = img2 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_k = img2 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric()) %>% 
    unite(col = "img1_cluster_id", img1_nk, img1_k, 
          sep = "-", remove = FALSE) %>% 
    unite(col = "img2_cluster_id", img2_nk, img2_k, 
          sep = "-", remove = FALSE) %>% 
    mutate(permutation = p)
  
}
 
# Filter permutations data for desired cluster numbers
# and combine Jacobians
df_permutations_nk <- list_permutations %>% 
  bind_rows() %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(permutation, img1_nk, img2_nk, img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity), .groups = "drop")


# Compute p-values -----------------------------------------------------------

# Compute p-values for cluster correlations
df_similarity_nk[["pval"]] <- 0
for (i in 1:nrow(df_similarity_nk)) {
  df_similarity_nk[[i, "pval"]] <- sum(df_permutations_nk[["similarity"]] >= df_similarity_nk[[i, "similarity"]])/nrow(df_permutations_nk)
}

# Compute q-values and -log10 transforms
df_similarity_nk <- df_similarity_nk %>% 
  mutate(qval = p.adjust(pval, method = "fdr"),
         pval_log = -log10(pval),
         qval_log = -log10(qval),
         significant = ifelse(pval < 0.05, TRUE, FALSE),
         pval_lab = ifelse(significant, "*", ""))


# Generate heatmap -----------------------------------------------------------

# Max and min similarity values
similarity_max <- max(df_similarity_nk[["similarity"]])
similarity_min <- min(df_similarity_nk[["similarity"]])

# Length of the heatmap palette
heatmap_palette_length <- 255

# Numerical values for the heatmap scale
heatmap_scale_values <- seq(similarity_min, similarity_max, length.out = heatmap_palette_length)
heatmap_scale_values <- (heatmap_scale_values - similarity_min)/(similarity_max - similarity_min)

# Colours for the heatmap palette 
heatmap_scale_colours <- magma(n = heatmap_palette_length, begin = 0.3)

# Heatmap palette vector
heatmap_scale_palette <- colorRampPalette(heatmap_scale_colours)(heatmap_palette_length)

# Clamp log p-values when infinite
df_similarity_nk <- df_similarity_nk %>% 
  mutate(pval_log = ifelse(is.infinite(pval_log), 3, pval_log))

# Heatmap plot
fig2_sim_heatmap <- ggplot(df_similarity_nk, 
                           aes(x = img2_cluster_id, 
                               y = fct_rev(img1_cluster_id), 
                               fill = similarity)) + 
  geom_tile(col = "grey50") + 
  geom_text(mapping = aes(label = pval_lab),
            size = 6, 
            hjust = "center", 
            vjust = "center",
            nudge_y = -0.12) + 
  labs(x = "Mouse clusters",
       y = "Human clusters",
       fill = "Correlation") + 
  scale_fill_gradientn(colors = heatmap_scale_palette,
                       values = heatmap_scale_values,
                       breaks = seq(0, 1, by = 0.1),
                       guide = guide_colourbar(title.position = "top",
                                               barheight = unit(60, "bigpts"),
                                               barwidth = unit(15, "bigpts"))) +
  scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
  scale_y_discrete(expand = expansion(mult = 0)) + 
  theme_bw() +
  theme(plot.margin = margin(t = 0, b = 0, l = 5, unit = "bigpts"),
        legend.position = c(1, 0),
        legend.justification = c("left", "bottom"))

# Export
outfile <- paste0("figure4_HBN_MICe_heatmap_nk6.pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(500/72, "in"),
    height = unit(500/72, "in"))
print(fig2_sim_heatmap)
dev.off()
```





# PONDSK-HBN

```{r fig4-PONDSK-HBN-heatmap}
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species/v3/779/")

# Cluster solutions to visualize
nk_1 <- 2
nk_2 <- 3


# Import similarity ----------------------------------------------------------

# Path to mouse-human similarity directory
similarity_dir <- file.path(pipeline_dir, "similarity")
similarity_file <- file.path(similarity_dir, "similarity.csv")

# Import the similarity data and extract cluster information
similarity <- read_csv(similarity_file, show_col_types = FALSE) %>% 
  mutate(img1_nk = img1 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_k = img1 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_jacobians = img1 %>% 
           str_extract("absolute|relative"),
         img2_nk = img2 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_k = img2 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_jacobians = img2 %>% 
           str_extract("absolute|relative"),) %>% 
  unite(col = "img1_cluster_id", img1_nk, img1_k, 
        sep = "-", remove = FALSE) %>% 
  unite(col = "img2_cluster_id", img2_nk, img2_k, 
        sep = "-", remove = FALSE)

# Filter similarity data for desired cluster numbers
# and combine Jacobians
df_similarity_nk <- similarity %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity),
            .groups = "drop")


# Import permutations --------------------------------------------------------

# Path to permutations directory
permutation_dir <- file.path(pipeline_dir, "permutations", "similarity")

# Permutation file names
permutation_files <- list.files(permutation_dir)

# Number of permutations
np <- length(permutation_files)
list_permutations <- vector(mode = "list", length = np)  
for (p in 1:np) {
  
  # Permutation data to import
  permutation_file <- permutation_files %>% 
    str_subset(str_c("similarity_permutation_", p, ".csv"))
  permutation_file <- file.path(permutation_dir, permutation_file)
  
  # Import permutation data
  list_permutations[[p]] <- read_csv(permutation_file, 
                                     show_col_types = FALSE) %>% 
    mutate(img1_nk = img1 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img1_k = img1 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_nk = img2 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_k = img2 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric()) %>% 
    unite(col = "img1_cluster_id", img1_nk, img1_k, 
          sep = "-", remove = FALSE) %>% 
    unite(col = "img2_cluster_id", img2_nk, img2_k, 
          sep = "-", remove = FALSE) %>% 
    mutate(permutation = p)
  
}
 
# Filter permutations data for desired cluster numbers
# and combine Jacobians
df_permutations_nk <- list_permutations %>% 
  bind_rows() %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(permutation, img1_nk, img2_nk, img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity), .groups = "drop")


# Compute p-values -----------------------------------------------------------

# Compute p-values for cluster correlations
df_similarity_nk[["pval"]] <- 0
for (i in 1:nrow(df_similarity_nk)) {
  df_similarity_nk[[i, "pval"]] <- sum(df_permutations_nk[["similarity"]] >= df_similarity_nk[[i, "similarity"]])/nrow(df_permutations_nk)
}

# Compute q-values and -log10 transforms
df_similarity_nk <- df_similarity_nk %>% 
  mutate(qval = p.adjust(pval, method = "fdr"),
         pval_log = -log10(pval),
         qval_log = -log10(qval),
         significant = ifelse(pval < 0.05, TRUE, FALSE),
         pval_lab = ifelse(significant, "*", ""))


# Generate heatmap -----------------------------------------------------------

# Max and min similarity values
similarity_max <- max(df_similarity_nk[["similarity"]])
similarity_min <- min(df_similarity_nk[["similarity"]])

# Length of the heatmap palette
heatmap_palette_length <- 255

# Numerical values for the heatmap scale
heatmap_scale_values <- seq(similarity_min, similarity_max, length.out = heatmap_palette_length)
heatmap_scale_values <- (heatmap_scale_values - similarity_min)/(similarity_max - similarity_min)

# Colours for the heatmap palette 
heatmap_scale_colours <- magma(n = heatmap_palette_length, begin = 0.3)

# Heatmap palette vector
heatmap_scale_palette <- colorRampPalette(heatmap_scale_colours)(heatmap_palette_length)

# Clamp log p-values when infinite
df_similarity_nk <- df_similarity_nk %>% 
  mutate(pval_log = ifelse(is.infinite(pval_log), 3, pval_log))

# Heatmap plot
fig2_sim_heatmap <- ggplot(df_similarity_nk, 
                           aes(x = img2_cluster_id, 
                               y = fct_rev(img1_cluster_id), 
                               fill = similarity)) + 
  geom_tile(col = "grey50") + 
  geom_text(mapping = aes(label = pval_lab),
            size = 6, 
            hjust = "center", 
            vjust = "center",
            nudge_y = -0.12) + 
  labs(x = "Mouse clusters",
       y = "Human clusters",
       fill = "Correlation") + 
  scale_fill_gradientn(colors = heatmap_scale_palette,
                       values = heatmap_scale_values,
                       breaks = seq(0, 1, by = 0.1),
                       guide = guide_colourbar(title.position = "top",
                                               barheight = unit(60, "bigpts"),
                                               barwidth = unit(15, "bigpts"))) +
  scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
  scale_y_discrete(expand = expansion(mult = 0)) + 
  theme_bw() +
  theme(plot.margin = margin(t = 0, b = 0, l = 5, unit = "bigpts"),
        legend.position = c(1, 0),
        legend.justification = c("left", "bottom"))

# Export
outfile <- paste0("figure4_PONDSK_HBN_heatmap.pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(500/72, "in"),
    height = unit(500/72, "in"))
print(fig2_sim_heatmap)
dev.off()
```

```{r}
df_similarity_nk %>% 
  select(img1_cluster_id, img2_cluster_id, similarity, pval)
```


```{r fig4-PONDSK-HBN-nk6-heatmap}
pipeline_dir <- file.path(PROJECTPATH, "data/cross_species/v3/779/")

# Cluster solutions to visualize
nk_1 <- 6
nk_2 <- 6


# Import similarity ----------------------------------------------------------

# Path to mouse-human similarity directory
similarity_dir <- file.path(pipeline_dir, "similarity")
similarity_file <- file.path(similarity_dir, "similarity.csv")

# Import the similarity data and extract cluster information
similarity <- read_csv(similarity_file, show_col_types = FALSE) %>% 
  mutate(img1_nk = img1 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_k = img1 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img1_jacobians = img1 %>% 
           str_extract("absolute|relative"),
         img2_nk = img2 %>% 
           basename() %>% 
           str_extract("_nk_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_k = img2 %>% 
           basename() %>% 
           str_extract("_k_[0-9]+") %>% 
           str_extract("[0-9]+") %>% 
           as.numeric(),
         img2_jacobians = img2 %>% 
           str_extract("absolute|relative"),) %>% 
  unite(col = "img1_cluster_id", img1_nk, img1_k, 
        sep = "-", remove = FALSE) %>% 
  unite(col = "img2_cluster_id", img2_nk, img2_k, 
        sep = "-", remove = FALSE)

# Filter similarity data for desired cluster numbers
# and combine Jacobians
df_similarity_nk <- similarity %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity),
            .groups = "drop")


# Import permutations --------------------------------------------------------

# Path to permutations directory
permutation_dir <- file.path(pipeline_dir, "permutations", "similarity")

# Permutation file names
permutation_files <- list.files(permutation_dir)

# Number of permutations
np <- length(permutation_files)
list_permutations <- vector(mode = "list", length = np)  
for (p in 1:np) {
  
  # Permutation data to import
  permutation_file <- permutation_files %>% 
    str_subset(str_c("similarity_permutation_", p, ".csv"))
  permutation_file <- file.path(permutation_dir, permutation_file)
  
  # Import permutation data
  list_permutations[[p]] <- read_csv(permutation_file, 
                                     show_col_types = FALSE) %>% 
    mutate(img1_nk = img1 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img1_k = img1 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_nk = img2 %>% 
             basename() %>% 
             str_extract("_nk_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric(),
           img2_k = img2 %>% 
             basename() %>% 
             str_extract("_k_[0-9]+") %>% 
             str_extract("[0-9]+") %>% 
             as.numeric()) %>% 
    unite(col = "img1_cluster_id", img1_nk, img1_k, 
          sep = "-", remove = FALSE) %>% 
    unite(col = "img2_cluster_id", img2_nk, img2_k, 
          sep = "-", remove = FALSE) %>% 
    mutate(permutation = p)
  
}
 
# Filter permutations data for desired cluster numbers
# and combine Jacobians
df_permutations_nk <- list_permutations %>% 
  bind_rows() %>% 
  filter(img1_nk == nk_1,
         img2_nk == nk_2) %>% 
  group_by(permutation, img1_nk, img2_nk, img1_cluster_id, img2_cluster_id) %>% 
  summarise(similarity = mean(similarity), .groups = "drop")


# Compute p-values -----------------------------------------------------------

# Compute p-values for cluster correlations
df_similarity_nk[["pval"]] <- 0
for (i in 1:nrow(df_similarity_nk)) {
  df_similarity_nk[[i, "pval"]] <- sum(df_permutations_nk[["similarity"]] >= df_similarity_nk[[i, "similarity"]])/nrow(df_permutations_nk)
}

# Compute q-values and -log10 transforms
df_similarity_nk <- df_similarity_nk %>% 
  mutate(qval = p.adjust(pval, method = "fdr"),
         pval_log = -log10(pval),
         qval_log = -log10(qval),
         significant = ifelse(pval < 0.05, TRUE, FALSE),
         pval_lab = ifelse(significant, "*", ""))


# Generate heatmap -----------------------------------------------------------

# Max and min similarity values
similarity_max <- max(df_similarity_nk[["similarity"]])
similarity_min <- min(df_similarity_nk[["similarity"]])

# Length of the heatmap palette
heatmap_palette_length <- 255

# Numerical values for the heatmap scale
heatmap_scale_values <- seq(similarity_min, similarity_max, length.out = heatmap_palette_length)
heatmap_scale_values <- (heatmap_scale_values - similarity_min)/(similarity_max - similarity_min)

# Colours for the heatmap palette 
heatmap_scale_colours <- magma(n = heatmap_palette_length, begin = 0.3)

# Heatmap palette vector
heatmap_scale_palette <- colorRampPalette(heatmap_scale_colours)(heatmap_palette_length)

# Clamp log p-values when infinite
df_similarity_nk <- df_similarity_nk %>% 
  mutate(pval_log = ifelse(is.infinite(pval_log), 3, pval_log))

# Heatmap plot
fig2_sim_heatmap <- ggplot(df_similarity_nk, 
                           aes(x = img2_cluster_id, 
                               y = fct_rev(img1_cluster_id), 
                               fill = similarity)) + 
  geom_tile(col = "grey50") + 
  geom_text(mapping = aes(label = pval_lab),
            size = 6, 
            hjust = "center", 
            vjust = "center",
            nudge_y = -0.12) + 
  labs(x = "Mouse clusters",
       y = "Human clusters",
       fill = "Correlation") + 
  scale_fill_gradientn(colors = heatmap_scale_palette,
                       values = heatmap_scale_values,
                       breaks = seq(0, 1, by = 0.1),
                       guide = guide_colourbar(title.position = "top",
                                               barheight = unit(60, "bigpts"),
                                               barwidth = unit(15, "bigpts"))) +
  scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
  scale_y_discrete(expand = expansion(mult = 0)) + 
  theme_bw() +
  theme(plot.margin = margin(t = 0, b = 0, l = 5, unit = "bigpts"),
        legend.position = c(1, 0),
        legend.justification = c("left", "bottom"))

# Export
outfile <- paste0("figure4_PONDSK_HBN_heatmap_nk6.pdf")
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(500/72, "in"),
    height = unit(500/72, "in"))
print(fig2_sim_heatmap)
dev.off()
```


