---
title: "Troubleshooting the cluster similarity matrices"
subtitle: "Overview of the issue"
author: "Antoine Beauchamp"
date: '2022-06-08'
output: 
  html_document:
    theme: paper
    highlight: pygments
    code_folding: hide
---

# Initialization


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(RMINC))
suppressPackageStartupMessages(library(data.tree))
suppressPackageStartupMessages(library(pheatmap))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(RColorBrewer))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(viridisLite))
suppressPackageStartupMessages(library(ggplotify))
```

# Functions

```{r functions}
source('../../functions/tree_tools.R')
source('../../functions/buildSimilarityMatrix.R')

process_signatures <- function(file){
  suppressMessages(read_csv(file)) %>% 
    mutate(nk = clusterfile %>% 
             str_extract('Clusternum_[0-9]+') %>% 
             str_extract('[0-9]+') %>% 
             as.numeric(),
           k = clusterfile %>% 
             str_extract('Group_[0-9]+') %>% 
             str_extract('[0-9]+') %>% 
             as.numeric()) %>% 
    arrange(nk, k) %>% 
    select(-exprfile, -clusterfile) %>% 
    unite(col = 'cluster_id', nk, k, sep = '-') %>% 
    column_to_rownames('cluster_id') %>% 
    as.matrix() %>% 
    t() 
}

generate_heatmap <- function(x, palette) {
  
  df_annotations <- tibble(cluster_ids = colnames(x)) %>% 
    separate(cluster_ids, into = c('nk', 'k'), remove = FALSE) %>% 
    mutate(nk = factor(nk, levels = 1:10),
           k = factor(k, levels = 1:10)) %>% 
    column_to_rownames(var = 'cluster_ids')
  
  df_colour_palette <- tibble(i = factor(1:10),
                              colour = palette)
  
  df_annotation_colours <- df_annotations %>% 
    left_join(df_colour_palette, by = c('nk' = 'i')) %>% 
    rename(nk_col = colour) %>% 
    left_join(df_colour_palette, by = c('k' = 'i')) %>% 
    rename(k_col = colour) 
  
  nk_colours <- df_annotation_colours$nk_col
  names(nk_colours) <- df_annotation_colours$nk
  
  k_colours <- df_annotation_colours$k_col
  names(k_colours) <- df_annotation_colours$k
  
  annotation_colours <- list(nk = nk_colours,
                             k = k_colours)
  
  p <- pheatmap(x, 
                cluster_cols = F, cluster_rows = F, 
                annotation_row = df_annotations,
                annotation_col = df_annotations,
                annotation_colors = annotation_colours, 
                silent = TRUE, 
                na_col = 'black')
  
  return(p)
}
```

# Overview

When running the preliminary analysis on the mouse and human clusters, I found that there was a discrepancy between the similarity matrices computed in the input gene space versus the average latent space. The input space similarity matrix seems to have more signal, compared with the latent space, which is not what I would have expected. The matrices are displayed below.  

```{r fig.width = 20, fig.height = 10}
palette <- mako(n = 10, direction = -1, begin = 0.3)

mouse_file <- 'data/mouse/cluster_signatures/input_space/mouse_cluster_signatures_rel_mean_threshold0.5_inputspace.csv'
human_file <- 'data/human/cluster_signatures/input_space/human_cluster_signatures_rel_mean_threshold0.5_inputspace.csv'

mat_mouse <- process_signatures(mouse_file)
mat_human <- process_signatures(human_file)

mat_sim <- buildSimilarityMatrix(x1 = mat_human,
                                 x2 = mat_mouse,
                                 method = 'correlation')

p_rel_inputspace <- as.ggplot(generate_heatmap(x = mat_sim, palette = palette)) +
  labs(title = 'Relative jacobian signatures with input space')

latent_space_file <- 'data/similarity/latent_space_100/similarity_hm_rel_mean_threshold0.5_latentspace100.csv'

mat_sim <- suppressMessages(read_csv(latent_space_file)) %>% 
  column_to_rownames('cluster_id') %>% 
  as.matrix()

p_rel_latentspace <- as.ggplot(generate_heatmap(x = mat_sim, palette = palette)) +
  labs(title = 'Relative jacobian signatures with latent space')

patchwork_plot <- p_rel_inputspace | p_rel_latentspace
patchwork_plot + plot_annotation(title = 'Cluster similarity using threshold of 0.5',
                                 subtitle = 'Rows human, columns mouse, scale correlation')
```

