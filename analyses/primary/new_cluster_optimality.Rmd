---
title: "Untitled"
output: html_document
date: "2025-06-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Initialization

```{r environment}
PROJECTPATH <- Sys.getenv("PROJECTPATH")
SRCPATH <- Sys.getenv("SRCPATH")
setwd(PROJECTPATH)
```

```{r functions}
source(file.path(SRCPATH, "analysis.R"))
source(file.path(SRCPATH, "enrichment.R"))

# Jaccard index of two sets
jaccard_index <- function(x, y) {length(intersect(x, y))/length(union(x, y))}

jaccard_fitness <- function(params_id, pipeline_dir, nk, gene_score = 950, B_threshold = 10, q_threshold = 0.05, pathway_ids = NULL) {

  dj <- 0
  for (ki in 1:nk) {
    if (ki > 1) {
      for (kj in 1:(ki-1)) {
        
        x <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = ki)
        
        y <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = kj)
        
        if (is.null(pathway_ids)) {
          x <- filter(x, B >= B_threshold, adj.P.Val < q_threshold)
          y <- filter(y, B >= B_threshold, adj.P.Val < q_threshold)
        } else {
          x <- filter(x, ID %in% pathway_ids, adj.P.Val < q_threshold)
          y <- filter(y, ID %in% pathway_ids, adj.P.Val < q_threshold)
        }
        
        x <- x[["Title"]]
        y <- y[["Title"]]
        
        dj <- dj + (1-jaccard_index(x = x, y = y))
        
      }
    }
  }
  
  dj <- (2/(nk*(nk-1)))*dj
  
  return(dj)
  
}
```

```{r paths}
output_dir <- file.path(PROJECTPATH, "analyses", "primary", "outputs", "cluster_optimality")
if (!dir.exists(output_dir)){
  dir.create(output_dir, recursive = TRUE)
}

mouse_params_id <- 107
mouse_pipeline_dir <- "data/mouse/derivatives/v3/"
mouse_pipeline_dir <- file.path(PROJECTPATH, mouse_pipeline_dir)

# Gene score for StringDB
gene_score <- 950
```


# Mouse cluster eigengap distribution

```{r eigengap}
# Cluster directories
mouse_cluster_dir <- file.path(mouse_pipeline_dir, mouse_params_id, 
                               "clusters", "resolution_0.2")

# Mouse affinity matrix
mouse_affinity_file <- file.path(mouse_cluster_dir, "affinity.csv")
mat_mouse_affinity <- as.matrix(read_csv(mouse_affinity_file, show_col_types = FALSE))
rownames(mat_mouse_affinity) <- colnames(mat_mouse_affinity)

# Max nk to examine
nk_max <- 10

# Get cluster metric distributions
df_mouse_cluster_metrics <- estimate_cluster_metrics(W = mat_mouse_affinity, 
                                                     NUMC = 2:nk_max)

df_eigengap <- df_mouse_cluster_metrics %>% 
  select(nk, eigengap)

plt <- ggplot(df_eigengap, aes(x = nk, y = eigengap)) + 
  geom_line() + 
  geom_point() +
    coord_cartesian(ylim = c(0, 0.1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 0.2, 0.01)) + 
  labs(x = "nk",
       y = "Eigengap",
       title = "Eigengap metric for mouse cluster solutions") + 
  theme_bw()

outfile <- "eigengap.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"), 
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

# Assessing cluster optimality using the full set of pathways

## Discrete (binary) enrichment

### Jaccard fitness 

```{r}
# Thresholds of q-values to determine pathway enrichment
q_thresholds <- c(0.05, 10^-c(2:6))

# Iterate over q-value thresholds
list_jaccard <- vector(mode = "list", length = length(q_thresholds))
for (l in 1:length(list_jaccard)) {
  
  # For each nk, evaluate the jaccard fitness 
  df_jaccard <- tibble(nk = 2:10, jaccard = 0)
  for (i in 1:nrow(df_jaccard)) {
    df_jaccard[[i, "jaccard"]] <- jaccard_fitness(params_id = mouse_params_id,
                                                  pipeline_dir = mouse_pipeline_dir,
                                                  nk = df_jaccard[[i, "nk"]], 
                                                  q_threshold = q_thresholds[l])
  }
  list_jaccard[[l]] <- df_jaccard %>% 
    mutate(q_threshold = q_thresholds[l])
}

df_jaccard_full <- bind_rows(list_jaccard) %>% 
  mutate(nlq = -log10(q_threshold))

plt <- ggplot(df_jaccard_full, 
              aes(x = nk, y = jaccard, 
                  col = nlq, group = nlq)) + 
  geom_line() + 
  geom_point() +
  coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Jaccard fitness",
       col = "-log10(q)",
       title = "Pathway separation across enrichment thresholds") + 
  theme_bw()

outfile <- "full_jaccard_fitness_qthresholds.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"), 
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

The pattern of pathway separability over clusters is consistent regardless of the q-value threshold used to determine pathway enrichment.

```{r}
# Join eigengap fitness and Jaccard fitness and apply min-max normalization
# q-threshold used is 0.05
df_fit_input <- inner_join(df_eigengap, 
                           filter(df_jaccard_full, q_threshold == 0.05), 
                           by = "nk") %>% 
  mutate(eigengap = (eigengap - min(eigengap))/(max(eigengap) - min(eigengap)),
         jaccard = (jaccard - min(jaccard))/(max(jaccard) - min(jaccard)))

# Compute fitness score over a range of mixing parameters
alpha_seq <- seq(0, 1, by = 0.2)
list_fit <- vector(mode = "list", length = length(alpha_seq))
for (i in 1:length(alpha_seq)) {
  alpha <- alpha_seq[i]
  list_fit[[i]] <- df_fit_input %>% 
    mutate(fitness = (1-alpha)*eigengap + alpha*jaccard,
           alpha = alpha) 
}


df_fit <- bind_rows(list_fit)

df_fit_long <- df_fit %>%
  pivot_longer(cols = c("eigengap", "jaccard", "fitness"), 
               names_to = "measure", 
               values_to = "score") %>% 
  mutate(measure = factor(measure, levels = c("eigengap", "jaccard", "fitness")),
         label = paste("alpha =", alpha))

plt <- ggplot(df_fit_long, aes(x = nk, y = score, col = measure, alpha = measure)) + 
  geom_line() + 
  geom_point() +
  facet_wrap(~label) +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  scale_color_manual(values = c("red", "blue", "black"), 
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  scale_alpha_manual(values = c(0.4, 0.4, 1.0),
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  labs(x = "nk", y = "Fitness score", 
       col = "Measure", alpha = "Measure",
       title = "Cluster optimality across mixing parameter values") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())

outfile <- "full_fitness_minmax.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"), 
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

The optimum is dominated by either 4 clusters when the mixing favourizes the eigengap or 10 clusters when it favourizes the pathway separability.

```{r}
ggplot(df_fit, aes(x = nk, y = fitness, col = alpha, group = alpha)) + 
  geom_line() + 
  geom_point() +
  scale_color_distiller(palette ="RdYlBu", direction = 1) + 
    scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  labs(x = "nk", y = "Fitness score", col = "Mixing parameter") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())
```

```{r}
df_fit_long %>% 
  filter(measure == "fitness") %>% 
  group_by(alpha) %>% 
  filter(score == max(score)) %>% 
  ungroup() %>% 
  select(alpha, score, nk)
```


### Mutual information

```{r pathways-import}
bader_modules <- file.path(PROJECTPATH, "data/human/enrichment/", "Human_Reactome_October_01_2023_symbol.gmt")  
bader_modules <- importMsigDBGMT(bader_modules)

df_modules_size <- map_dbl(bader_modules[["MODULES2GENES"]], length) %>% 
  enframe(name = "ID", value = "B") %>% 
  inner_join(bader_modules[["MODULES"]], by = "ID")

# Pathway size threshold
B_threshold <- 10

# Pathways to keep
pathway_ids_keep <- df_modules_size %>% 
  filter(B >= B_threshold) %>% 
  pull(ID)
```


```{r}
mutual_information <- function(params_id, pipeline_dir, nk, gene_score = 950, q_threshold = 0.05) {

  MI_tot <- 0
  for (ki in 1:nk) {
    if (ki > 1) {
      for (kj in 1:(ki-1)) {
        
        x <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = ki) %>%
          filter(ID %in% pathway_ids_keep) %>% 
          arrange(ID) %>% 
          mutate(enriched = adj.P.Val < q_threshold) %>% 
          pull(enriched)
        
        y <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = kj) %>%
          filter(ID %in% pathway_ids_keep) %>% 
          arrange(ID) %>% 
          mutate(enriched = adj.P.Val < q_threshold) %>% 
          pull(enriched)
        
        # dj <- dj + (1-jaccard_index(x = x, y = y))
        
        # Joint probabilities
        p_xy <- matrix(data = 0, nrow = 2, ncol = 2)
        p_xy[1,1] <- sum(!x & !y)
        p_xy[1,2] <- sum(!x & y)
        p_xy[2,1] <- sum(x & !y)
        p_xy[2,2] <- sum(x & y)
        p_xy <- p_xy/N
        
        # Compute mutual information
        MI <- 0
        for (i in 1:nrow(p_xy)) {
          for (j in 1:ncol(p_xy)) {
            if (p_xy[i,j] != 0) {
              MI <- MI + p_xy[i,j]*log(p_xy[i,j]/(rowSums(p_xy)[i]*colSums(p_xy)[j]), base = 2)
            }
          }
        }
        
        MI_tot <- MI_tot + (1-MI)
        
      }
    }
  }
  
  MI_tot <- (2/(nk*(nk-1)))*MI_tot
  
  return(MI_tot)
  
}
```

```{r}
df_MI <- tibble(nk = 2:10, MI = 0)
for (i in 1:nrow(df_MI)) {
  df_MI[[i, "MI"]] <- mutual_information(params_id = mouse_params_id,
                                          pipeline_dir = mouse_pipeline_dir,
                                          nk = df_MI[[i, "nk"]])
}

ggplot(df_MI, aes(x = nk, y = MI)) + 
  geom_line() + 
  geom_point() +
  scale_x_continuous(breaks = 1:20) + 
  labs(x = "nk",
       y = "1 - MI") + 
  theme_bw()
```

```{r}
df_jaccard %>% 
  filter(q_threshold == 0.05) %>% 
  select(nk, jaccard) %>% 
  inner_join(df_MI, by = "nk") %>% 
  pivot_longer(cols = -nk, names_to = "metric", values_to = "value") %>% 
  group_by(metric) %>% 
  mutate(value = (value - min(value))/(max(value) - min(value))) %>% 
  ungroup() %>% 
  ggplot(aes(x = nk, y = value, col = metric)) + 
  geom_line() + 
  geom_point() +
  scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  labs(x = "nk", y = "Normalized (min-max) score", col = "Metric") + 
  scale_color_discrete(labels = c("Jaccard", "Mutual information")) + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())
```


## Continuous enrichment

```{r}
df_module_sizes <- get_module_sizes(modules = bader_modules)

# Pathway size threshold
B_threshold <- 10

# Pathways to keep
pathway_ids_keep <- df_modules_size %>% 
  filter(B >= B_threshold, B < 500) %>% 
  pull(ID)
```


```{r}
params_id <- mouse_params_id
pipeline_dir <- mouse_pipeline_dir
nk <- 2
gene_score <- 950
pathway_ids <- pathway_ids_keep
measure <- "NLQ"

pathway_fitness <- function(params_id, pipeline_dir, nk, gene_score = 950, measure = "E", metric = "MSE", pathway_ids = NULL) {

  if (!(measure %in% c("E", "NLQ", "adj.P.Val"))) {stop()}
  
  d <- 0
  for (ki in 1:nk) {
    if (ki > 1) {
      for (kj in 1:(ki-1)) {
        
        x <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = ki)
        
        y <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = kj)
        
        x <- mutate(x, E = ifelse(is.na(E), 0, E))
        y <- mutate(y, E = ifelse(is.na(E), 0, E))
        
        # x <- mutate(x, NLQ = ifelse(adj.P.Val >= 0.05, 0, NLQ))
        # y <- mutate(y, NLQ = ifelse(adj.P.Val >= 0.05, 0, NLQ))
        
        if (!is.null(pathway_ids)) {
          x <- x %>% filter(ID %in% pathway_ids) %>% arrange(ID)
          y <- y %>% filter(ID %in% pathway_ids) %>% arrange(ID)
        } else {
          x <- x %>% arrange(ID)
          y <- y %>% arrange(ID)
        }
        
        x <- x[[measure]]
        y <- y[[measure]]
        
        if (metric == "correlation") {
          d <- d + (1-cor(x,y))
        } else if (metric == "MSE") {
          d <- d + mean((x-y)^2)
        } else {
          stop()
        }
      }
    }
  }
  
  d <- (2/(nk*(nk-1)))*d
  
  return(d)
  
}
```

```{r}
pathway_fitness(params_id = mouse_params_id, 
                pipeline_dir = mouse_pipeline_dir, 
                nk = 7, pathway_ids = pathway_ids_keep)
```

```{r}
metrics <- c("correlation", "MSE")
measures <- c("E", "NLQ")

list_fitness <- vector(mode = "list", length = length(metrics))
names(list_fitness) <- metrics
for (l in 1:length(list_fitness)) {

  list_fitness[[l]] <- vector(mode = "list", length = length(measures))
  names(list_fitness[[l]]) <- measures
  for (ll in 1:length(list_fitness[[l]])) {
    
    # For each nk, evaluate the jaccard fitness 
    df_fitness <- tibble(nk = 2:10, fitness = 0)
    for (i in 1:nrow(df_fitness)) {
      df_fitness[[i, "fitness"]] <- pathway_fitness(params_id = mouse_params_id,
                                                    pipeline_dir = mouse_pipeline_dir,
                                                    nk = df_fitness[[i, "nk"]], 
                                                    metric = metrics[l],
                                                    measure = measures[ll],
                                                    pathway_ids = pathway_ids_keep)
    }
    list_fitness[[l]][[ll]] <- df_fitness %>% 
      mutate(measure = measures[ll], 
             metric = metrics[l])
    
  }
}

df_fitness <- list_fitness %>% map(bind_rows) %>% bind_rows
```

```{r}
plt <- ggplot(filter(df_fitness, metric == "MSE"), 
              aes(x = nk, y = fitness)) + 
  geom_line() + 
  geom_point() +
  # facet_grid(measure~metric, scales = "free_y") + 
  facet_wrap(~measure, nrow = 2, ncol = 1, scales = "free_y") +
  # coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  # scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Fitness",
       title = "Pathway separation via mean squared error") + 
  theme_bw()

# outfile <- "full_jaccard_fitness_qthresholds.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(8, "in"), 
#     height = unit(4, "in"))
# print(plt)
# dev.off()

plt
```

```{r}
plt <- ggplot(filter(df_fitness, metric == "correlation"), 
              aes(x = nk, y = fitness)) + 
  geom_line() + 
  geom_point() +
  # facet_grid(measure~metric, scales = "free_y") + 
  facet_wrap(~measure, nrow = 2, ncol = 1, scales = "free_y") +
  # coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  # scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Fitness",
       title = "Pathway separation via correlation distance") + 
  theme_bw()

# outfile <- "full_jaccard_fitness_qthresholds.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(8, "in"), 
#     height = unit(4, "in"))
# print(plt)
# dev.off()

plt
```

```{r}
# Join eigengap fitness and Jaccard fitness and apply min-max normalization
# q-threshold used is 0.05
df_fit_input <- inner_join(df_eigengap, 
                           filter(df_fitness, metric == "MSE", measure == "NLQ"), 
                           by = "nk") %>% 
  rename(pathway = fitness) %>% 
  mutate(eigengap = (eigengap - min(eigengap))/(max(eigengap) - min(eigengap)),
         pathway = (pathway - min(pathway))/(max(pathway) - min(pathway)))

# Compute fitness score over a range of mixing parameters
alpha_seq <- seq(0, 1, by = 0.2)
list_fit <- vector(mode = "list", length = length(alpha_seq))
for (i in 1:length(alpha_seq)) {
  alpha <- alpha_seq[i]
  list_fit[[i]] <- df_fit_input %>% 
    mutate(fitness = (1-alpha)*eigengap + alpha*pathway,
           alpha = alpha) 
}


df_fit <- bind_rows(list_fit)

df_fit_long <- df_fit %>%
  pivot_longer(cols = c("eigengap", "pathway", "fitness"), 
               names_to = "term", 
               values_to = "score") %>% 
  mutate(term = factor(term, levels = c("eigengap", "pathway", "fitness")),
         label = paste("alpha =", alpha))

plt <- ggplot(df_fit_long, aes(x = nk, y = score, col = term, alpha = term)) + 
  geom_line() + 
  geom_point() +
  facet_wrap(~label) +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  scale_color_manual(values = c("red", "blue", "black"), 
                     labels = c("Eigengap", "Pathway", "Total")) + 
  scale_alpha_manual(values = c(0.4, 0.4, 1.0),
                     labels = c("Eigengap", "Pathway", "Total")) + 
  labs(x = "nk", y = "Fitness score", 
       col = "Term", alpha = "Term",
       title = "Cluster optimality across mixing parameter values") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())

# outfile <- "full_fitness_minmax.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(8, "in"), 
#     height = unit(4, "in"))
# print(plt)
# dev.off()

plt
```

```{r}
enrichment_comparison <- function(params_id, pipeline_dir, nk, gene_score = 950, measure = "E", pathway_ids = NULL) {

  if (!(measure %in% c("E", "NLQ", "adj.P.Val"))) {stop()}
    
  l <- 1
  list_enrichment <- vector(mode = "list", length = nk*(nk-1)/2)
  for (ki in 1:nk) {
    if (ki > 1) {
      for (kj in 1:(ki-1)) {
        
        x <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = ki)
        
        y <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nk, k = kj)
        
        x <- mutate(x, E = ifelse(is.na(E), 0, E))
        y <- mutate(y, E = ifelse(is.na(E), 0, E))
        
        if (!is.null(pathway_ids)) {
          x <- x %>% filter(ID %in% pathway_ids) %>% arrange(ID)
          y <- y %>% filter(ID %in% pathway_ids) %>% arrange(ID)
        } else {
          x <- x %>% arrange(ID)
          y <- y %>% arrange(ID)
        }
        
        x <- x[[measure]]
        y <- y[[measure]]
        
        list_enrichment[[l]] <- tibble(x = x, y = y, kx = ki, ky = kj)
        l <- l + 1
        
      }
    }
  }
  
  out <- bind_rows(list_enrichment)
  
  return(out)
  
}
```


```{r}
df_enrichment <- enrichment_comparison(params_id = mouse_params_id, 
                                       pipeline_dir = mouse_pipeline_dir, 
                                       measure = "NLQ", 
                                       nk = 8, pathway_ids = pathway_ids_keep)

df_enrichment %>% 
  filter(kx == 7, ky == 2) %>% 
  ggplot(aes(x = x, y = y)) + 
  geom_point()
```

```{r}
df_enrichment %>% 
  filter(kx == 3, ky == 1) %>% 
  ggplot(aes(x = x, y = y)) + 
  geom_point()
```

```{r}
df_enrichment %>% 
  filter(kx == 4, ky == 2) %>% 
  mutate(ID = 1:nrow(.))
```

```{r}
df_fitness
```

```{r fig.height = 10, fig.width = 5}
df_enrichment <- enrichment_comparison(params_id = mouse_params_id, 
                                       pipeline_dir = mouse_pipeline_dir, 
                                       measure = "NLQ", 
                                       nk = 2, pathway_ids = pathway_ids_keep)

df_plt <- df_enrichment %>% 
  mutate(ID = 1:nrow(.),
         distance = (x - y)^2)

ggplot(df_plt, aes(y = ID)) + 
  geom_segment(mapping = aes(x = 0, xend = distance)) +
  geom_point(mapping = aes(x = distance)) + 
  geom_vline(xintercept = mean(df_plt$distance), 
             col = "red") + 
  labs(x = "Distance", y = "Pathway") + 
  theme_bw() + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
  
print(mean((df_plt$x - df_plt$y)^2))
```

```{r fig.height = 10, fig.width = 5}
df_enrichment <- enrichment_comparison(params_id = mouse_params_id, 
                                       pipeline_dir = mouse_pipeline_dir, 
                                       measure = "NLQ", 
                                       nk = 8, pathway_ids = pathway_ids_keep)

df_plt <- df_enrichment %>% 
  filter(kx == 4, ky == 2) %>% 
  mutate(ID = 1:nrow(.),
         distance = (x - y)^2)

ggplot(df_plt, aes(y = ID)) + 
  geom_segment(mapping = aes(x = 0, xend = distance)) +
  geom_point(mapping = aes(x = distance)) + 
  geom_vline(xintercept = mean(df_plt$distance), 
             col = "red") + 
  labs(x = "Distance", y = "Pathway") + 
  theme_bw() + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

print(mean((df_plt$x - df_plt$y)^2))
```

```{r}
list_clusters <- vector(mode = "list", length = 9)
for (nk in 2:10) {
  list_clusters[[nk-1]] <- expand_grid(kx = 1:nk, ky = 1:nk) %>% 
    mutate(nk = nk)
}

df_clusters <- bind_rows(list_clusters) %>% mutate(distance = 0)
for (i in 1:nrow(df_clusters)) {

    x <- import_enrichment_mouse(params_id = params_id,
                               pipeline_dir = pipeline_dir,
                               gene_score = gene_score,
                               nk = df_clusters[[i, "nk"]], 
                               k = df_clusters[[i, "kx"]])
  
  y <- import_enrichment_mouse(params_id = params_id,
                               pipeline_dir = pipeline_dir,
                               gene_score = gene_score,
                               nk = df_clusters[[i, "nk"]], 
                               k = df_clusters[[i, "ky"]])
  
  x <- mutate(x, E = ifelse(is.na(E), 0, E))
  y <- mutate(y, E = ifelse(is.na(E), 0, E))
  
  x <- x %>% filter(ID %in% pathway_ids_keep) %>% arrange(ID)
  y <- y %>% filter(ID %in% pathway_ids_keep) %>% arrange(ID)
  
  x <- x[["NLQ"]]
  y <- y[["NLQ"]]
  
  df_clusters[[i, "distance"]] <- mean((x-y)^2)
  
}




tmp <- df_clusters %>% 
  unite(col = "cluster_id_x", nk, kx, sep = "-", remove = FALSE) %>% 
  unite(col = "cluster_id_y", nk, ky, sep = "-", remove = FALSE) %>% 
  mutate(distance = ifelse(cluster_id_x == cluster_id_y, NA, distance))

cluster_id_lvls <- tmp %>% 
  select(cluster_id_x, nk, kx) %>% 
  distinct() %>% 
  arrange(nk, kx) %>% 
  pull(cluster_id_x)

tmp <- tmp %>% 
  mutate(cluster_id_x = factor(cluster_id_x, levels = cluster_id_lvls)) %>% 
  mutate(cluster_id_y = factor(cluster_id_y, levels = cluster_id_lvls))

ggplot(tmp, aes(x = cluster_id_x, y = fct_rev(cluster_id_y), fill = distance)) + 
  geom_tile(na.rm = TRUE) +
  scale_fill_continuous(na.value = "grey90") + 
  theme_bw()
```



```{r}
nonzero <- runif(n = 500, min = 5, max = 30)
zero <- rep(0, 500)
test <- tibble(x = c(nonzero, zero),
               y = c(zero, nonzero))

ggplot(test, aes(x = x, y = y)) + 
  geom_point()


sqrt(sum((x-y)^2))
```


```{r}
cluster_ids <- character()
for (nk in 2:10) {
  for (k in 1:nk) {
    cluster_ids <- c(cluster_ids, paste(nk, k, sep = "-"))
  }
}

list_enrichment <- vector(mode = "list", length = length(cluster_ids))
for (i in 1:length(list_enrichment)) {
  nk <- str_split(cluster_ids[i], pattern = "-")[[1]][[1]]
  k <- str_split(cluster_ids[i], pattern = "-")[[1]][[2]]
  list_enrichment[[i]] <- import_enrichment_mouse(params_id = params_id,
                                                  pipeline_dir = pipeline_dir,
                                                  gene_score = gene_score,
                                                  nk = nk, k = k) %>% 
    filter(ID %in% pathway_ids_keep) %>% 
    arrange(ID)
  
}

df_enrichment <- bind_rows(list_enrichment) 

df_enrichment <- df_enrichment %>% 
  unite(col = "cluster_id", nk, k, sep = "-", remove = FALSE)

df_enrichment %>% 
  filter(rank <= 50) %>% 
ggplot(aes(x = rank, y = NLQ, col = factor(nk), group = cluster_id)) + 
  geom_line()
```

```{r}
list_enrichment[[1]] %>% 
  arrange(rank)
```



# Assessing cluster optimality using the set of pre-selected pathways

```{r}
# Set of pre-selected pathways
pathway_ids <- c("ADHERENS JUNCTIONS INTERACTIONS%REACTOME DATABASE ID RELEASE 38%418990",
                 "AXON GUIDANCE%REACTOME%R-HSA-422475.7",
                 "CA2+ PATHWAY%REACTOME%R-HSA-4086398.4",
                 "CHROMATIN ORGANIZATION%REACTOME DATABASE ID RELEASE 38%4839726",
                 "GAP JUNCTION TRAFFICKING AND REGULATION%REACTOME%R-HSA-157858.2",
                 "GENE EXPRESSION (TRANSCRIPTION)%REACTOME%R-HSA-74160.8",
                 "GENERIC TRANSCRIPTION PATHWAY%REACTOME%R-HSA-212436.12",
                 "LONG-TERM POTENTIATION%REACTOME DATABASE ID RELEASE 38%9620244",
                 "MAPK FAMILY SIGNALING CASCADES%REACTOME%R-HSA-5683057.4",
                 "MTOR SIGNALLING%REACTOME%R-HSA-165159.7",
                 "PROTEIN-PROTEIN INTERACTIONS AT SYNAPSES%REACTOME DATABASE ID RELEASE 38%6794362",
                 "SIGNALING BY ERBB2%REACTOME DATABASE ID RELEASE 38%1227986",
                 "SIGNALING BY ERBB4%REACTOME DATABASE ID RELEASE 38%1236394",
                 "SIGNALING BY GPCR%REACTOME DATABASE ID RELEASE 38%372790",
                 "SIGNALING BY HEDGEHOG%REACTOME DATABASE ID RELEASE 38%5358351",
                 "SIGNALING BY NOTCH%REACTOME%R-HSA-157118.6",
                 "SIGNALING BY VEGF%REACTOME%R-HSA-194138.3",
                 "SIGNALING BY WNT%REACTOME DATABASE ID RELEASE 38%195721",
                 "TIGHT JUNCTION INTERACTIONS%REACTOME DATABASE ID RELEASE 38%420029",
                 "TRANSMISSION ACROSS CHEMICAL SYNAPSES%REACTOME%R-HSA-112315.7")
```

```{r}
q_thresholds <- c(0.05, 10^-c(2:6))

list_jaccard <- vector(mode = "list", length = length(q_thresholds))
for (l in 1:length(list_jaccard)) {
  df_jaccard <- tibble(nk = 2:10, jaccard = 0)
  for (i in 1:nrow(df_jaccard)) {
    df_jaccard[[i, "jaccard"]] <- jaccard_fitness(params_id = mouse_params_id,
                                                  pipeline_dir = mouse_pipeline_dir,
                                                  nk = df_jaccard[[i, "nk"]], 
                                                  pathway_ids = pathway_ids,
                                                  q_threshold = q_thresholds[l])
  }
  list_jaccard[[l]] <- df_jaccard %>% 
    mutate(q_threshold = q_thresholds[l])
}

df_jaccard_preselect <- bind_rows(list_jaccard) %>% 
  mutate(nlq = -log10(q_threshold))

plt <- ggplot(df_jaccard_preselect, aes(x = nk, y = jaccard, col = nlq, group = nlq)) + 
  geom_line() + 
  geom_point() +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Jaccard fitness",
       col = "-log10(q)",
       title = "Pathway separation across enrichment thresholds") + 
  theme_bw()

outfile <- "preselected_jaccard_fitness_qthresholds.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

```{r}
df_jaccard_compare <- bind_rows(df_jaccard_full %>% 
                                  filter(q_threshold == 0.05) %>% 
                                  select(nk, jaccard) %>% 
                                  mutate(pathways = "Full set"),
                                df_jaccard_preselect %>% 
                                  filter(q_threshold == 0.05) %>% 
                                  select(nk, jaccard) %>% 
                                  mutate(pathways = "Pre-selected set"))

plt <- ggplot(df_jaccard_compare, aes(x = nk, y = jaccard, col = pathways, group = pathways)) + 
  geom_line() + 
  geom_point() +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Jaccard fitness",
       col = "Pathway set",
       title = "Jaccard fitness comparison between full and pre-selected pathway sets") + 
  theme_bw()

outfile <- "pathway_set_jaccard_comparison.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

The Jaccard fitness behaves similarly regardless of whether we use the full set of pathways or the pre-selected set.

```{r}
df_fit_input <- inner_join(df_eigengap, filter(df_jaccard_preselect, q_threshold == 0.05), by = "nk") %>% 
  mutate(eigengap = (eigengap - min(eigengap))/(max(eigengap) - min(eigengap)),
         jaccard = (jaccard - min(jaccard))/(max(jaccard) - min(jaccard)))

alpha_seq <- seq(0, 1, by = 0.2)
list_fit <- vector(mode = "list", length = length(alpha_seq))
for (i in 1:length(alpha_seq)) {
  alpha <- alpha_seq[i]
  list_fit[[i]] <- df_fit_input %>% 
    mutate(fitness = (1-alpha)*eigengap + alpha*jaccard,
           alpha = alpha) 
}


df_fit <- bind_rows(list_fit)

df_fit_long <- df_fit %>%
  pivot_longer(cols = c("eigengap", "jaccard", "fitness"), names_to = "measure", values_to = "score") %>% 
  mutate(measure = factor(measure, levels = c("eigengap", "jaccard", "fitness")),
         label = paste("alpha =", alpha))

plt <- ggplot(df_fit_long, aes(x = nk, y = score, col = measure, alpha = measure)) + 
  geom_line() + 
  geom_point() +
  facet_wrap(~label) +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  scale_color_manual(values = c("red", "blue", "black"), 
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  scale_alpha_manual(values = c(0.4, 0.4, 1.0),
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  labs(x = "nk", y = "Fitness score", col = "Measure", alpha = "Measure",
       title = "Cluster optimality across mixing parameter values") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())

outfile <- "preselected_fitness_minmax.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```


# Mouse clusters with human matches

```{r}
# Modified Jaccard fitness function that takes cluster IDs rather than just nk
jaccard_fitness_2 <- function(params_id, pipeline_dir, cluster_ids, gene_score = 950, B_threshold = 10, q_threshold = 0.05, pathway_ids = NULL) {
  
  dj <- 0
  count <- 0
  for (i in 1:length(cluster_ids)) {
    if (i > 1){
      for (j in 1:(i-1)) {
        
        nki <- str_split(cluster_ids[i], "-")[[1]][1]
        ki <- str_split(cluster_ids[i], "-")[[1]][2]
        
        nkj <- str_split(cluster_ids[j], "-")[[1]][1]
        kj <- str_split(cluster_ids[j], "-")[[1]][2]
        
        x <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nki, k = ki)
        
        y <- import_enrichment_mouse(params_id = params_id,
                                     pipeline_dir = pipeline_dir,
                                     gene_score = gene_score,
                                     nk = nkj, k = kj)
        
        if (is.null(pathway_ids)) {
          x <- filter(x, B >= B_threshold, adj.P.Val < q_threshold)
          y <- filter(y, B >= B_threshold, adj.P.Val < q_threshold)
        } else {
          x <- filter(x, ID %in% pathway_ids, adj.P.Val < q_threshold)
          y <- filter(y, ID %in% pathway_ids, adj.P.Val < q_threshold)
        }
        
        x <- x[["Title"]]
        y <- y[["Title"]]
        
        dj <- dj + (1-jaccard_index(x = x, y = y))
        
        count <- count + 1
        
      }
    }
  }
  
  dj <- dj/count
  
  return(dj)
  
}
```

```{r}
# Import cluster similarity
similarity <- import_similarity(param_id = 375, 
                                pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Import cluster similarity permutations
permutations <- import_similarity_permutations(param_id = 375,
                                               pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Compute significance of correlations
df_sim_pvals <- compute_similarity_significance(similarity = similarity,
                                                permutations = permutations)

colnames(df_sim_pvals) <- str_replace(colnames(df_sim_pvals), "img1", "human")
colnames(df_sim_pvals) <- str_replace(colnames(df_sim_pvals), "img2", "mouse")
```

```{r}
df_matching_clusters <- df_sim_pvals %>% 
  filter(pval < 0.05) %>%
  # filter(pval < 0.10) %>% 
  select(mouse_cluster_id, mouse_nk, mouse_k) %>% 
  arrange(mouse_nk, mouse_k) %>% 
  distinct()


q_thresholds <- c(0.05, 10^-c(2:6))

list_jaccard_matching <- vector(mode = "list", length = length(q_thresholds))
for (l in 1:length(list_jaccard_matching)) {
  df_jaccard_matching <- tibble(nk = 2:10, jaccard = 0)
  for (i in 1:nrow(df_jaccard_matching)) {

    cluster_ids <- df_matching_clusters %>%
      filter(mouse_nk == df_jaccard[[i, "nk"]]) %>%
      pull(mouse_cluster_id)
    
    df_jaccard_matching[[i, "jaccard"]] <- jaccard_fitness_2(params_id = mouse_params_id,
                                                    pipeline_dir = mouse_pipeline_dir,
                                                    cluster_ids = cluster_ids,
                                                    q_threshold = q_thresholds[l])
    
  }
  list_jaccard_matching[[l]] <- df_jaccard_matching %>% 
    mutate(q_threshold = q_thresholds[l])
  
}

df_jaccard_matching_0.05 <- bind_rows(list_jaccard_matching) %>% 
  mutate(nlq = -log10(q_threshold))

plt <- ggplot(df_jaccard_matching_0.05, aes(x = nk, y = jaccard, col = nlq, group = nlq)) + 
  geom_line() + 
  geom_point() +
  coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Jaccard fitness",
       col = "-log10(q)",
       title = "Pathway separation across enrichment thresholds") + 
  theme_bw()

outfile <- "matching_clusters_jaccard_fitness_qthresholds_0.05.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

```{r}
df_matching_clusters <- df_sim_pvals %>% 
  filter(pval < 0.10) %>%
  select(mouse_cluster_id, mouse_nk, mouse_k) %>% 
  arrange(mouse_nk, mouse_k) %>% 
  distinct()


q_thresholds <- c(0.05, 10^-c(2:6))

list_jaccard_matching <- vector(mode = "list", length = length(q_thresholds))
for (l in 1:length(list_jaccard_matching)) {
  df_jaccard_matching <- tibble(nk = 2:10, jaccard = 0)
  for (i in 1:nrow(df_jaccard_matching)) {

    cluster_ids <- df_matching_clusters %>%
      filter(mouse_nk == df_jaccard[[i, "nk"]]) %>%
      pull(mouse_cluster_id)
    
    df_jaccard_matching[[i, "jaccard"]] <- jaccard_fitness_2(params_id = mouse_params_id,
                                                    pipeline_dir = mouse_pipeline_dir,
                                                    cluster_ids = cluster_ids,
                                                    q_threshold = q_thresholds[l])
    
  }
  list_jaccard_matching[[l]] <- df_jaccard_matching %>% 
    mutate(q_threshold = q_thresholds[l])
  
}

df_jaccard_matching_0.10 <- bind_rows(list_jaccard_matching) %>% 
  mutate(nlq = -log10(q_threshold))

plt <- ggplot(df_jaccard_matching_0.10, aes(x = nk, y = jaccard, col = nlq, group = nlq)) + 
  geom_line() + 
  geom_point() +
  coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Jaccard fitness",
       col = "-log10(q)",
       title = "Pathway separation across enrichment thresholds") + 
  theme_bw()

outfile <- "matching_clusters_jaccard_fitness_qthresholds_0.10.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```

```{r}
df_jaccard_comparison <- bind_rows(df_jaccard_matching_0.05 %>% 
                                     filter(q_threshold == 0.05) %>% 
                                     select(nk, jaccard) %>% 
                                     mutate(clusters = "Clusters with matches (p < 0.05)"),
                                   df_jaccard_matching_0.10 %>% 
                                     filter(q_threshold == 0.05) %>% 
                                     select(nk, jaccard) %>% 
                                     mutate(clusters = "Clusters with matches (p < 0.10)"),
                                   df_jaccard_full %>% 
                                     filter(q_threshold == 0.05) %>% 
                                     select(nk, jaccard) %>% 
                                     mutate(clusters = "All clusters"))

plt <- ggplot(df_jaccard_comparison, 
       aes(x = nk, y = jaccard, col = clusters)) + 
  geom_line() + 
  geom_point() + 
  coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = 1:20) + 
  scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
  labs(x = "nk",
       y = "Jaccard fitness",
       col = "Cluster set") + 
  theme_bw()

outfile <- "cluster_set_jaccard_comparison.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```


```{r}
df_fit_input <- inner_join(df_eigengap, filter(df_jaccard_matching_0.05, q_threshold == 0.05), by = "nk") %>% 
  mutate(eigengap = (eigengap - min(eigengap))/(max(eigengap) - min(eigengap)),
         jaccard = (jaccard - min(jaccard))/(max(jaccard) - min(jaccard)))


alpha_seq <- seq(0, 1, by = 0.2)
list_fit <- vector(mode = "list", length = length(alpha_seq))
for (i in 1:length(alpha_seq)) {
  alpha <- alpha_seq[i]
  list_fit[[i]] <- df_fit_input %>% 
    mutate(fitness = (1-alpha)*eigengap + alpha*jaccard,
           alpha = alpha) 
}


df_fit <- bind_rows(list_fit)

df_fit_long <- df_fit %>%
  pivot_longer(cols = c("eigengap", "jaccard", "fitness"), names_to = "measure", values_to = "score") %>% 
  mutate(measure = factor(measure, levels = c("eigengap", "jaccard", "fitness")),
         label = paste("alpha =", alpha))

plt <- ggplot(df_fit_long, aes(x = nk, y = score, col = measure, alpha = measure)) + 
  geom_line() + 
  geom_point() +
  facet_wrap(~label) +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  scale_color_manual(values = c("red", "blue", "black"), 
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  scale_alpha_manual(values = c(0.4, 0.4, 1.0),
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  labs(x = "nk", y = "Fitness score", col = "Measure", alpha = "Measure",
       title = "Cluster optimality across mixing parameter values") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())

outfile <- "matching_clusters_fitness_minmax_0.05.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```


```{r}
df_fit_input <- inner_join(df_eigengap, filter(df_jaccard_matching_0.10, q_threshold == 0.05), by = "nk") %>% 
  mutate(eigengap = (eigengap - min(eigengap))/(max(eigengap) - min(eigengap)),
         jaccard = (jaccard - min(jaccard))/(max(jaccard) - min(jaccard)))


alpha_seq <- seq(0, 1, by = 0.2)
list_fit <- vector(mode = "list", length = length(alpha_seq))
for (i in 1:length(alpha_seq)) {
  alpha <- alpha_seq[i]
  list_fit[[i]] <- df_fit_input %>% 
    mutate(fitness = (1-alpha)*eigengap + alpha*jaccard,
           alpha = alpha) 
}


df_fit <- bind_rows(list_fit)

df_fit_long <- df_fit %>%
  pivot_longer(cols = c("eigengap", "jaccard", "fitness"), names_to = "measure", values_to = "score") %>% 
  mutate(measure = factor(measure, levels = c("eigengap", "jaccard", "fitness")),
         label = paste("alpha =", alpha))

plt <- ggplot(df_fit_long, aes(x = nk, y = score, col = measure, alpha = measure)) + 
  geom_line() + 
  geom_point() +
  facet_wrap(~label) +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_x_continuous(breaks = 1:10) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.2)) + 
  scale_color_manual(values = c("red", "blue", "black"), 
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  scale_alpha_manual(values = c(0.4, 0.4, 1.0),
                     labels = c("Eigengap", "Jaccard", "Total")) + 
  labs(x = "nk", y = "Fitness score", col = "Measure", alpha = "Measure",
       title = "Cluster optimality across mixing parameter values") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())

outfile <- "matching_clusters_fitness_minmax_0.10.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt)
dev.off()

plt
```