---
title: "Human cluster pathway enrichment"
author: "Antoine Beauchamp"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r packages}
suppressPackageStartupMessages(library(tidyverse))
```

```{r environment}
PROJECTPATH <- Sys.getenv("PROJECTPATH")
SRCPATH <- Sys.getenv("SRCPATH")
setwd(PROJECTPATH)
```

```{r functions}
source(file.path(SRCPATH, "analysis.R"))

importMsigDBGMT <- function(file) {
  # stop("This does not work at the present.")
  msig <- list()
  con <- file(file, open = "r")
  lines <- readLines(con)
  close(con)
  ids <- gsub("\t.*", "", lines)
  desc <- gsub("^[^\t]*\t([^\t]*)\t.*", "\\1", lines)
  genes <- gsub("^[^\t]*\t[^\t]*\t(.*)", "\\1", lines)
  msig$MODULES <- data.frame(ID = ids, Title = desc, stringsAsFactors = FALSE)
  if (any(duplicated(msig$MODULES$ID))) {
    warning("Duplicated IDs found; automatic IDs will be generated")
    msig$MODULES$oldID <- msig$MODULES$ID
    msig$MODULES$ID <- make.unique(as.character(msig$MODULES$ID))
  }
  rownames(msig$MODULES) <- msig$MODULES[, "ID"]
  msig$MODULES2GENES <- strsplit(genes, "\t")
  names(msig$MODULES2GENES) <- ids
  msig$GENES <- data.frame(ID = unique(unlist(msig$MODULES2GENES)))
  # msig <- new("tmod", msig)
  msig
}
```

```{r directories}
output_dir <- file.path(PROJECTPATH, "analyses", "primary", "outputs", "human_cluster_pathways")
if (!dir.exists(output_dir)){
  dir.create(output_dir, recursive = TRUE)
}
```


# Pathway module characteristics

```{r}
bader_modules <- file.path(PROJECTPATH, "data/human/enrichment/", "Human_Reactome_October_01_2023_symbol.gmt")  
bader_modules <- importMsigDBGMT(bader_modules)

df_modules_size <- map_dbl(bader_modules[["MODULES2GENES"]], length) %>% 
  enframe(name = "ID", value = "B") %>% 
  inner_join(bader_modules[["MODULES"]], by = "ID")
```

```{r pathways-ecdf}
B <- sort(df_modules_size$B)
B_max <- max(B)
B_min <- 0

B_n <- 1e3
B_seq <- seq(B_min, B_max, length.out = B_n)
B_ecdf <- numeric(length(B_seq))
for (i in 1:B_n) {B_ecdf[i] <- sum(B <= B_seq[i])/length(B)}

pathways_ecdf <- tibble(B = B_seq,
       cdf = B_ecdf) %>% 
  ggplot(aes(x = B, y = cdf)) + 
  geom_line() +
  # geom_point(size = 0.5) + 
  scale_x_continuous(breaks = seq(0, 3000, by = 200)) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) + 
  labs(x = "Number of genes in pathway module",
       y = "ECDF") + 
  theme_bw()

outfile <- "pathways_ecdf.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(6, "in"),
    height = unit(3, "in"))
print(pathways_ecdf)
dev.off()

pathways_ecdf
```

There are a lot of small pathways.

```{r pathways-small}
n_lt_100 <- df_modules_size %>% 
  filter(B < 100) %>% 
  nrow()

n_lt_10 <- df_modules_size %>% 
  filter(B < 10) %>% 
  nrow()

print(n_lt_100/nrow(df_modules_size))
print(n_lt_10/nrow(df_modules_size))
```

90% of pathways have fewer than 100 genes. 
39% of pathways have fewer than ~10 genes. 

```{r pathways-largest}
df_modules_size %>% 
  arrange(desc(B)) %>% 
  select(Title, B) %>% 
  head(n = 20)
```

```{r pathways-smallest}
df_modules_size %>% 
  arrange(B) %>% 
  select(Title, B)
```

```{r pathways-subset}
# Pathway size threshold
B_threshold <- 10

# Pathways to keep
pathway_ids_keep <- df_modules_size %>% 
  filter(B >= B_threshold) %>% 
  pull(ID)
```


# Cluster pathway enrichment

```{r params}
human_params_id <- 700
human_pipeline_dir <- "data/human/derivatives/v3/"
human_pipeline_dir <- file.path(PROJECTPATH, human_pipeline_dir)

mouse_params_id <- 107
mouse_pipeline_dir <- "data/mouse/derivatives/v3/"
mouse_pipeline_dir <- file.path(PROJECTPATH, mouse_pipeline_dir)

# Gene score for StringDB
gene_score <- 950
```

## Mouse pathway enrichment numbers

```{r}
nk_max <- 10
n_enriched <- c()
for (nk in 2:nk_max) {
  for (k in 1:nk) {
    mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                                pipeline_dir = mouse_pipeline_dir, 
                                                nk = nk, k = k)
    
    mouse_enrichment <- mouse_enrichment %>% 
      filter(ID %in% pathway_ids_keep) %>% 
      arrange(ID)
    
    n_enriched <- c(n_enriched, sum(mouse_enrichment$adj.P.Val < 0.05))
    
  }
}

max(n_enriched)
max(n_enriched)/nrow(mouse_enrichment)
```


## Human 2-cluster with pre-selected pathways

```{r pathway-ids-preselected}
pathway_ids <- c("ADHERENS JUNCTIONS INTERACTIONS%REACTOME DATABASE ID RELEASE 38%418990",
                 "AXON GUIDANCE%REACTOME%R-HSA-422475.7",
                 "CA2+ PATHWAY%REACTOME%R-HSA-4086398.4",
                 "CHROMATIN ORGANIZATION%REACTOME DATABASE ID RELEASE 38%4839726",
                 "GAP JUNCTION TRAFFICKING AND REGULATION%REACTOME%R-HSA-157858.2",
                 "GENE EXPRESSION (TRANSCRIPTION)%REACTOME%R-HSA-74160.8",
                 "GENERIC TRANSCRIPTION PATHWAY%REACTOME%R-HSA-212436.12",
                 "LONG-TERM POTENTIATION%REACTOME DATABASE ID RELEASE 38%9620244",
                 "MAPK FAMILY SIGNALING CASCADES%REACTOME%R-HSA-5683057.4",
                 "MTOR SIGNALLING%REACTOME%R-HSA-165159.7",
                 "PROTEIN-PROTEIN INTERACTIONS AT SYNAPSES%REACTOME DATABASE ID RELEASE 38%6794362",
                 "SIGNALING BY ERBB2%REACTOME DATABASE ID RELEASE 38%1227986",
                 "SIGNALING BY ERBB4%REACTOME DATABASE ID RELEASE 38%1236394",
                 "SIGNALING BY GPCR%REACTOME DATABASE ID RELEASE 38%372790",
                 "SIGNALING BY HEDGEHOG%REACTOME DATABASE ID RELEASE 38%5358351",
                 "SIGNALING BY NOTCH%REACTOME%R-HSA-157118.6",
                 "SIGNALING BY VEGF%REACTOME%R-HSA-194138.3",
                 "SIGNALING BY WNT%REACTOME DATABASE ID RELEASE 38%195721",
                 "TIGHT JUNCTION INTERACTIONS%REACTOME DATABASE ID RELEASE 38%420029",
                 "TRANSMISSION ACROSS CHEMICAL SYNAPSES%REACTOME%R-HSA-112315.7")
```

```{r}
nk_human <- 2; k_human <- 1
nk_mouse <- 4; k_mouse <- 1

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = nk_human, k = k_human)

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = nk_mouse, k = k_mouse)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids) %>% 
  arrange(ID)

mouse_alpha_seq_auc <- 2:10
mouse_alpha_seq_auc <- (1/10)^mouse_alpha_seq_auc
mouse_alpha_seq_auc <- c(0.05, mouse_alpha_seq_auc)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq_auc)

enrichment_AUC <- map_dbl(enrichment_ROC, pROC::auc)

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq_auc)
```


```{r}
df_roc_all %>% 
  mutate(nlq = -log10(mouse_alpha),
         nlq = factor(nlq)) %>% 
  ggplot(aes(x = fpr, y = tpr, col = nlq)) + 
  annotate(geom = "segment",
           x = 0, xend = 1,
           y = 0, yend = 1,
           size = 0.3,
           linetype = "dashed",
           col = "black") +
  geom_line(size = 0.35) +
  # facet_wrap(~NLQ_mouse_lab, nrow = 2, ncol = 2) + 
  scale_x_continuous(limits = c(0, 1)) + 
  scale_y_continuous(limits = c(0, 1), 
                     expand = expansion(add = 0.1)) + 
  # scale_color_manual(values = pathways_human_palette) + 
  labs(x = "False positive rate",
       y = "True positive rate") +
  theme_bw()
```

```{r}
mouse_alpha_seq_auc <- 2:10
mouse_alpha_seq_auc <- (1/10)^mouse_alpha_seq_auc
mouse_alpha_seq_auc <- c(0.05, mouse_alpha_seq_auc)

df_auc <- tibble(alpha = mouse_alpha_seq_auc,
                 auc = 0)
for (i in 1:nrow(df_auc)) {
  
  predictor <- human_enrichment %>% 
    pull(adj.P.Val)
  
  outcome <- mouse_enrichment %>% 
    mutate(pass = adj.P.Val < df_auc[[i, "alpha"]]) %>% 
    pull(pass)
  
  # Compute AUC
  df_auc[[i, "auc"]] <- pROC::auc(outcome, 1-predictor, quiet = TRUE)[1]
  
}

ggplot(df_auc, aes(x = -log10(alpha), y = auc)) + 
  geom_line() + 
  geom_point() + 
  coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = seq(2.0, 10.0, by = 1)) + 
  theme_bw()
```


## Human 2-cluster with all pathways

```{r}
human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = 2, k = 1)

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = 4, k = 1)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_alpha_seq <- 2:10
mouse_alpha_seq <- (1/10)^mouse_alpha_seq
mouse_alpha_seq <- c(0.05, mouse_alpha_seq)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq)

enrichment_ROC_AUC <- map_dbl(enrichment_ROC, pROC::auc) %>% 
  enframe(name = "alpha", value = "AUC") %>% 
  mutate(alpha = as.numeric(alpha))

enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment,
                                       human_enrichment = human_enrichment,
                                       alpha = mouse_alpha_seq)

enrichment_PR_AUC <- map_dfr(.x = enrichment_PR, 
                             .f = function(x){
                               tibble(AUC = x[["auc.integral"]], 
                                      Prop = x[["true.proportion"]])
                             }, .id = "alpha") %>% 
  mutate(alpha = as.numeric(alpha))

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq)

head(enrichment_HG)
```

```{r}
plt_nk2_ROC_AUC <- ggplot(enrichment_ROC_AUC, 
       aes(x = -log10(alpha), y = AUC)) +
  geom_line() + 
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_point() + 
  coord_cartesian(ylim = c(0.5, 1.0)) + 
  scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) +
  labs(x = "Mouse threshold (-log10(q))",
       y = "ROC AUC",
       title = "ROC pathway comparison between human 2-1 and mouse 4-1") + 
  theme_bw()

outfile <- "pathway_comparison_nk2_ROC_AUC.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(6, "in"),
    height = unit(3, "in"))
print(plt_nk2_ROC_AUC)
dev.off()

plt_nk2_ROC_AUC
```

```{r}
plt_nk2_PR_AUC <- enrichment_PR_AUC %>% 
  rename(Chance = Prop) %>% 
  pivot_longer(cols = -alpha, names_to = "measure", values_to = "values") %>% 
  ggplot(aes(x = -log10(alpha), y = values)) +
  geom_line(aes(group = measure, linetype = measure)) + 
  geom_point() + 
  scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
  labs(x = "Mouse threshold (-log10(q))",
       y = "PR AUC",
       title = "Precision-recall pathway comparison between human 2-1 and mouse 4-1") + 
  theme_bw() +
  theme(title = element_text(size = 7))

outfile <- "pathway_comparison_nk2_PR_AUC.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(6, "in"),
    height = unit(3, "in"))
print(plt_nk2_PR_AUC)
dev.off()

plt_nk2_PR_AUC
```

```{r}
plt_nk2_HG <- enrichment_HG %>% 
  ggplot(aes(x = -log10(alpha_human), y = -log10(pval), col = factor(round(-log10(alpha_mouse), 2)))) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
  labs(x = "Human threshold (-log10(q))",
       y = "-log10(p)",
       col = "Mouse threshold (-log10(q))",
       title = "Hypergeometric test pathway comparison between human 2-1 and mouse 4-1") + 
  scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
  scale_y_continuous(breaks = seq(0, 20, by = 2)) + 
  theme_bw()

outfile <- "pathway_comparison_nk2_HG.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt_nk2_HG)
dev.off()

plt_nk2_HG
```
### Random chance

```{r}
sum(mouse_enrichment$adj.P.Val < 0.05)
sum(human_enrichment$adj.P.Val < 0.05)
```

```{r}
n_sim <- 500
mouse_alpha_seq <- c(0.05, 1e-2, 1e-4, 1e-6, 1e-8, 1e-10)
list_ROC_AUC <- vector(mode = "list", length = length(mouse_alpha_seq))
list_PR_AUC <- vector(mode = "list", length = length(mouse_alpha_seq))
list_HG <- vector(mode = "list", length = length(mouse_alpha_seq))
for (i in 1:length(mouse_alpha_seq)) {
  
  alpha <- mouse_alpha_seq[i]
  n_true <- sum(mouse_enrichment$adj.P.Val < alpha)
  
  list_ROC_AUC_i <- vector(mode = "list", length = n_sim)
  list_PR_AUC_i <- vector(mode = "list", length = n_sim)
  list_HG_i <- vector(mode = "list", length = n_sim)
  for (s in 1:n_sim) {
    
    mouse_enrichment_test <- mouse_enrichment %>% mutate(adj.P.Val = 1)
    set.seed(s)
    idx_flip <- sample(1:nrow(mouse_enrichment_test), size = n_true, replace = FALSE)
    mouse_enrichment_test$adj.P.Val[idx_flip] <- 0
    
    
    enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment_test, 
                                             human_enrichment = human_enrichment,
                                             alpha = alpha)
    
    enrichment_ROC_AUC <- map_dbl(enrichment_ROC, pROC::auc) %>% 
      enframe(name = "alpha", value = "AUC") %>% 
      mutate(alpha = as.numeric(alpha))
    
    list_ROC_AUC_i[[s]] <- enrichment_ROC_AUC
    
    enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment_test,
                                           human_enrichment = human_enrichment,
                                           alpha = alpha)
    
    enrichment_PR_AUC <- map_dfr(.x = enrichment_PR, 
                                 .f = function(x){
                                   tibble(AUC = x[["auc.integral"]], 
                                          Prop = x[["true.proportion"]])
                                 }, .id = "alpha") %>% 
      mutate(alpha = as.numeric(alpha))

    list_PR_AUC_i[[s]] <- enrichment_PR_AUC
    
    enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment_test, 
                                               human_enrichment = human_enrichment,
                                               alpha_mouse = alpha,
                                               alpha_human = c(0.05, 1e-3, 1e-5, 1e-10))
    
    list_HG_i[[s]] <- enrichment_HG
        
  }
  
  list_ROC_AUC[[i]] <- bind_rows(list_ROC_AUC_i, .id = "sample")
  list_PR_AUC[[i]] <- bind_rows(list_PR_AUC_i, .id = "sample")
  list_HG[[i]] <- bind_rows(list_HG_i, .id = "sample")
  
}

df_ROC_AUC <- bind_rows(list_ROC_AUC)
df_PR_AUC <- bind_rows(list_PR_AUC)
df_HG <- bind_rows(list_HG)
```


```{r}
ggplot(df_ROC_AUC, aes(x = -log10(alpha), y = AUC)) + 
  geom_line(aes(group = sample),
            alpha = 0.03) + 
  geom_point(alpha = 0.05) + 
  geom_hline(yintercept = 0.5, linetype = "dashed", col = "red", linewidth = 1) + 
  coord_cartesian(ylim = c(0.3, 1)) + 
  scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
  labs(x = "Mouse threshold (-log10(q))",
       y = "ROC AUC") + 
  theme_bw()
```

```{r}
df_PR_true_prop <- df_PR_AUC %>% select(alpha, Prop) %>% distinct()

ggplot(df_PR_AUC, aes(x = -log10(alpha), y = AUC)) + 
  geom_line(aes(group = sample),
            alpha = 0.03) + 
  geom_point(alpha = 0.1) + 
  geom_line(data = df_PR_true_prop, 
            mapping = aes(x = -log10(alpha), y = Prop),
            col = "red", linetype = "dashed", linewidth = 1) + 
  # coord_cartesian(ylim = c(0.3, 1)) + 
  scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
  labs(x = "Mouse threshold (-log10(q))",
       y = "PR AUC") + 
  theme_bw()
```

```{r}
tmp <- df_HG %>% 
  filter(alpha_human == 0.05)

ggplot(df_HG, aes(x = -log10(alpha_mouse), y = -log10(pval))) + 
  geom_line(aes(group = sample),
            alpha = 0.03) + 
  geom_point(alpha = 0.5) + 
  geom_hline(yintercept = -log10(0.05), col = "red", linetype = "dashed") + 
  facet_wrap(~round(-log10(alpha_human), 2)) +
  # facet_wrap(~alpha_human) + 
  # coord_cartesian(ylim = c(0.3, 1)) + 
  scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
  labs(x = "Mouse threshold (-log10(q))",
       y = "-log10(p)") + 
  theme_bw()
```


```{r}
enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment,
                                       human_enrichment = human_enrichment,
                                       alpha = mouse_alpha)

enrichment_PR_AUC <- map_dfr(.x = enrichment_PR, 
                             .f = function(x){
                               tibble(AUC = x[["auc.integral"]], 
                                      Prop = x[["true.proportion"]])
                             }, .id = "alpha") %>% 
  mutate(alpha = as.numeric(alpha))

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq)
```


## Comparison between human 7-2 and mouse nk = 7

```{r}
human_cluster_id <- "7-2"
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

mouse_nk <- 7
mouse_k <- 1

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = mouse_nk, k = mouse_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

```


### Random chance behaviour for human 7-2

```{r}
n_sim <- 500

n_enriched_seq <- c(300, 100, 50, 25, 10, 5:1)
mouse_alpha_seq <- c(0.05, 1e-2, 1e-4, 1e-6, 1e-8, 1e-10)
list_ROC_AUC <- vector(mode = "list", length = length(n_enriched_seq))
list_PR_AUC <- vector(mode = "list", length = length(n_enriched_seq))
list_HG <- vector(mode = "list", length = length(n_enriched_seq))
for (i in 1:length(n_enriched_seq)) {

  n_true <- n_enriched_seq[i]  
  
  list_ROC_AUC_i <- vector(mode = "list", length = n_sim)
  list_PR_AUC_i <- vector(mode = "list", length = n_sim)
  list_HG_i <- vector(mode = "list", length = n_sim)
  for (s in 1:n_sim) {
    mouse_enrichment_test <- mouse_enrichment %>% mutate(adj.P.Val = 1)
    set.seed(s)
    idx_flip <- sample(1:nrow(mouse_enrichment_test), size = n_true, replace = FALSE)
    mouse_enrichment_test$adj.P.Val[idx_flip] <- 0
    
    enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment_test, 
                                             human_enrichment = human_enrichment,
                                             alpha = 0.05)
    
    enrichment_ROC_AUC <- map_dbl(enrichment_ROC, pROC::auc) %>% 
      enframe(name = "alpha", value = "AUC") %>% 
      mutate(alpha = as.numeric(alpha),
             n_enriched = n_true)
    
    list_ROC_AUC_i[[s]] <- enrichment_ROC_AUC
    
    enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment_test,
                                           human_enrichment = human_enrichment,
                                           alpha = 0.05)
    
    enrichment_PR_AUC <- map_dfr(.x = enrichment_PR, 
                                 .f = function(x){
                                   tibble(AUC = x[["auc.integral"]], 
                                          Prop = x[["true.proportion"]])
                                 }, .id = "alpha") %>% 
      mutate(alpha = as.numeric(alpha),
             n_enriched = n_true)
    
    list_PR_AUC_i[[s]] <- enrichment_PR_AUC
    
    enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment_test, 
                                               human_enrichment = human_enrichment,
                                               alpha_mouse = alpha,
                                               alpha_human = c(0.05, 1e-3, 1e-5, 1e-10))
    
    list_HG_i[[s]] <- enrichment_HG
    
  }
  
  list_ROC_AUC[[i]] <- bind_rows(list_ROC_AUC_i, .id = "sample")
  list_PR_AUC[[i]] <- bind_rows(list_PR_AUC_i, .id = "sample")
  list_HG[[i]] <- bind_rows(list_HG_i, .id = "sample")
  
}

df_ROC_AUC <- bind_rows(list_ROC_AUC)
df_PR_AUC <- bind_rows(list_PR_AUC)
df_HG <- bind_rows(list_HG)
```


```{r}
# n_enriched <- df_ROC_AUC %>% 
  # select(alpha, n_enriched) %>% 
  # distinct() %>% 
  # arrange(desc(alpha)) %>% 
  # pull(n_enriched)

ggplot(df_ROC_AUC, aes(x = n_enriched, y = AUC)) + 
  geom_line(aes(group = sample),
            alpha = 0.03) + 
  geom_point(alpha = 0.05) + 
  geom_hline(yintercept = 0.5, linetype = "dashed", col = "red", linewidth = 1) + 
  coord_cartesian(ylim = c(0.3, 1)) + 
  # scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2), 
  #                    sec.axis = dup_axis(labels = n_enriched,
  #                                        name = "Number of mouse pathways enriched")) + 
  labs(x = "Number of mouse pathways enriched",
       y = "ROC AUC") + 
  theme_bw()
```

```{r}
df_ROC_AUC_quantiles <- df_ROC_AUC %>% 
  group_by(n_enriched) %>% 
  summarise(AUC_lwr = quantile(AUC, probs = 0.025),
            AUC_upr = quantile(AUC, probs = 0.975))
```


```{r}
df_PR_true_prop <- df_PR_AUC %>% select(alpha, Prop) %>% distinct()

ggplot(df_PR_AUC, aes(x = n_enriched, y = AUC)) + 
  geom_line(aes(group = sample),
            alpha = 0.03) + 
  geom_point(alpha = 0.1) + 
  geom_abline(intercept = 0, slope = 1/nrow(human_enrichment),
              col = "red", linetype = "dashed", linewidth = 1) +
  # geom_line(data = df_PR_true_prop, 
  #           mapping = aes(x = -log10(alpha), y = Prop),
  #           col = "red", linetype = "dashed", linewidth = 1) + 
  # coord_cartesian(ylim = c(0, 0.12)) +
  # scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2), 
  #                    sec.axis = dup_axis(labels = n_enriched,
  #                                        name = "Number of mouse pathways enriched")) +
  scale_x_continuous(breaks = seq(0, 500, by = 20)) + 
  labs(x = "Number of mouse pathways enriched",
       y = "PR AUC") + 
  theme_bw()
```

```{r}
df_PR_AUC_quantiles <- df_PR_AUC %>% 
  group_by(n_enriched) %>% 
  summarise(AUC_chance = mean(Prop),
            AUC_lwr = quantile(AUC, probs = 0.025),
            AUC_upr = quantile(AUC, probs = 0.975))

df_PR_AUC_quantiles
```


```{r}
tmp <- df_HG %>% 
  filter(alpha_human == 0.05)

ggplot(df_HG, aes(x = B, y = -log10(pval))) + 
  geom_line(aes(group = sample),
            alpha = 0.03) + 
  # geom_beeswarm() + 
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = -log10(0.05), col = "red", linetype = "dashed") + 
  facet_wrap(~round(-log10(alpha_human), 2)) +
  # facet_wrap(~alpha_human) + 
  # coord_cartesian(ylim = c(0.3, 1)) + 
  # scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
  labs(x = "Mouse threshold (-log10(q))",
       y = "-log10(p)") + 
  theme_bw()
```

```{r}
df_HG_sig_prop <- df_HG %>% 
  mutate(significant = pval < 0.05) %>% 
  group_by(alpha_human, B) %>% 
  summarise(n_sig = sum(significant),
            prop_sig = n_sig/n_sim, 
            .groups = "drop")

ggplot(df_HG_sig_prop, aes(x = B, y = prop_sig, col = factor(-log10(alpha_human)))) + 
  geom_point()
```


### Best cluster match: Human 7-2 to mouse 7-1

```{r}
# Import cluster similarity
similarity <- import_similarity(param_id = 375, 
                                pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Import cluster similarity permutations
permutations <- import_similarity_permutations(param_id = 375,
                                               pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Compute significance of correlations
df_sim_pvals <- compute_similarity_significance(similarity = similarity,
                                                permutations = permutations)

df_sim_pvals %>% 
  filter(img1_cluster_id == "7-2", img2_nk == 7) %>% 
  select(img2_cluster_id, similarity, pval) %>% 
  arrange(pval)
```

```{r}
human_cluster_id <- "7-2"
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

mouse_cluster_id <- "7-1"
mouse_nk <- str_split(mouse_cluster_id, "-")[[1]][1]
mouse_k <- str_split(mouse_cluster_id, "-")[[1]][2]

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = mouse_nk, k = mouse_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_alpha_seq <- 2:10
mouse_alpha_seq <- (1/10)^mouse_alpha_seq
mouse_alpha_seq <- c(0.05, mouse_alpha_seq)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq)

enrichment_ROC_AUC <- inner_join(map_dbl(enrichment_ROC, pROC::auc) %>% 
                                   enframe(name = "alpha", value = "AUC") %>% 
                                   mutate(alpha = as.numeric(alpha)),
                                 map_dbl(enrichment_ROC, function(x){sum(x[["original.response"]])}) %>% 
                                   enframe(name = "alpha", value = "n_enriched") %>% 
                                   mutate(alpha = as.numeric(alpha)),
                                 by = "alpha")

enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment,
                                       human_enrichment = human_enrichment,
                                       alpha = mouse_alpha_seq)

enrichment_PR_AUC <- map_dfr(.x = enrichment_PR, 
                             .f = function(x){
                               tibble(AUC = x[["auc.integral"]], 
                                      prop = x[["true.proportion"]],
                                      n_enriched = prop*nrow(human_enrichment))
                             }, .id = "alpha") %>% 
  mutate(alpha = as.numeric(alpha))

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha_mouse = mouse_alpha_seq)
```

```{r}
enrichment_ROC_AUC <- enrichment_ROC_AUC %>% 
  mutate(NL = round(-log10(alpha), 2))

ggplot(enrichment_ROC_AUC, 
       aes(x = n_enriched, y = AUC)) + 
  geom_line() + 
  geom_point() + 
  geom_ribbon(data = df_ROC_AUC_quantiles, 
              mapping = aes(x = n_enriched, ymin = AUC_lwr, ymax = AUC_upr),
              inherit.aes = FALSE,
              alpha = 0.3, fill = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", col = "red") + 
  coord_cartesian(xlim = c(0, 130),
                  ylim = c(0.4, 1.0)) +
  scale_x_continuous(breaks = seq(0, 200, by = 20),
                     sec.axis = dup_axis(breaks = enrichment_ROC_AUC$n_enriched,
                                         labels = enrichment_ROC_AUC$NL,
                                         name = "Mouse threshold (-log10(q))")) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) + 
  labs(x = "Number of mouse pathways enriched",
       y = "ROC AUC",
       title = "ROC pathway comparison between human 7-2 and mouse 7-1") + 
  theme_bw()
```

```{r}
# plt_H72_M71_ROC_AUC <- ggplot(enrichment_ROC_AUC, 
#        aes(x = -log10(alpha), y = AUC)) +
#   geom_line() + 
#   geom_point() + 
#   geom_ribbon(data = df_ROC_AUC_quantiles, 
#               mapping = aes(x = -log10(alpha), ymin = AUC_lwr, ymax = AUC_upr),
#               inherit.aes = FALSE,
#               alpha = 0.3, fill = "red") + 
#   geom_hline(yintercept = 0.5, linetype = "dashed", col = "red") + 
#   coord_cartesian(ylim = c(0.4, 1.0)) + 
#   scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) +
#   scale_y_continuous(breaks = seq(0, 1, by = 0.1)) + 
#   labs(x = "Mouse threshold (-log10(q))",
#        y = "ROC AUC",
#        title = "ROC pathway comparison between human 7-2 and mouse 7-1") + 
#   theme_bw()

# outfile <- "pathway_comparison_H7-2_M7-1_ROC_AUC.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(6, "in"),
#     height = unit(3, "in"))
# print(plt_H72_M71_ROC_AUC)
# dev.off()

# plt_H72_M71_ROC_AUC
```

```{r}
enrichment_PR_AUC <- enrichment_PR_AUC %>% 
  mutate(NL = round(-log10(alpha), 2))

plt_H72_M71_PR_AUC <- ggplot(enrichment_PR_AUC, 
                             aes(x = n_enriched, y = AUC)) + 
  geom_line() + 
  geom_point() +
  geom_ribbon(data = df_PR_AUC_quantiles, 
              mapping = aes(x = n_enriched, ymin = AUC_lwr, ymax = AUC_upr),
              inherit.aes = FALSE,
              alpha = 0.3, fill = "red") + 
  geom_line(data = df_PR_AUC_quantiles, 
            mapping = aes(y = AUC_chance),
            linetype = "dashed", col = "red") + 
    coord_cartesian(xlim = c(0, 130)) +
  scale_x_continuous(breaks = seq(0, 200, by = 20),
                     sec.axis = dup_axis(breaks = enrichment_PR_AUC$n_enriched,
                                         labels = enrichment_PR_AUC$NL,
                                         name = "Mouse threshold (-log10(q))")) +
  labs(x = "Number of mouse pathways enriched",
       y = "PR AUC",
       title = "Precision-recall pathway comparison between human 7-2 and mouse 7-1") + 
  theme_bw()

# outfile <- "pathway_comparison_H7-2_M7-1_PR_AUC.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(6, "in"),
#     height = unit(3, "in"))
# print(plt_H72_M71_PR_AUC)
# dev.off()

plt_H72_M71_PR_AUC
```

```{r}
plt_H72_M71_HG <- enrichment_HG %>% 
  ggplot(aes(x = B, y = -log10(pval), col = factor(round(-log10(alpha_human), 2)))) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
  labs(col = "Human threshold (-log10(q))",
       y = "-log10(p)",
       x = "Number of mouse pathways enriched",
       title = "Hypergeometric test pathway comparison between human 7-2 and mouse 7-1") + 
      coord_cartesian(xlim = c(0, 130)) +
  scale_x_continuous(breaks = seq(0, 200, by = 20),
                     sec.axis = dup_axis(breaks = enrichment_PR_AUC$n_enriched,
                                         labels = enrichment_PR_AUC$NL,
                                         name = "Mouse threshold (-log10(q))")) +
  scale_y_continuous(breaks = seq(0, 20, by = 2)) + 
  theme_bw()

# outfile <- "pathway_comparison_H7-2_M7-1_HG.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(8, "in"),
#     height = unit(4, "in"))
# print(plt_H72_M71_HG)
# dev.off()

plt_H72_M71_HG
```

```{r}
# plt_H72_M71_HG <- enrichment_HG %>% 
#   ggplot(aes(x = -log10(alpha_mouse), y = -log10(pval), col = factor(round(-log10(alpha_human), 2)))) + 
#   geom_line() + 
#   geom_point() +
#   geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
#   labs(col = "Human threshold (-log10(q))",
#        y = "-log10(p)",
#        x = "Mouse threshold (-log10(q))",
#        title = "Hypergeometric test pathway comparison between human 7-2 and mouse 7-1") + 
#   scale_x_continuous(breaks = round(-log10(mouse_alpha_seq), 2)) + 
#   scale_y_continuous(breaks = seq(0, 20, by = 2)) + 
#   theme_bw()

# outfile <- "pathway_comparison_H7-2_M7-1_HG.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(8, "in"),
#     height = unit(4, "in"))
# print(plt_H72_M71_HG)
# dev.off()

# plt_H72_M71_HG
```


### Worst cluster match: Human 7-2 to mouse 7-7

```{r}
human_cluster_id <- "7-2"
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

mouse_cluster_id <- "7-7"
mouse_nk <- str_split(mouse_cluster_id, "-")[[1]][1]
mouse_k <- str_split(mouse_cluster_id, "-")[[1]][2]

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = mouse_nk, k = mouse_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_alpha_seq <- 2:10
mouse_alpha_seq <- (1/10)^mouse_alpha_seq
mouse_alpha_seq <- c(0.05, mouse_alpha_seq)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq)

enrichment_ROC_AUC <- inner_join(map_dbl(enrichment_ROC, pROC::auc) %>% 
                                   enframe(name = "alpha", value = "AUC") %>% 
                                   mutate(alpha = as.numeric(alpha)),
                                 map_dbl(enrichment_ROC, function(x){sum(x[["original.response"]])}) %>% 
                                   enframe(name = "alpha", value = "n_enriched") %>% 
                                   mutate(alpha = as.numeric(alpha)),
                                 by = "alpha")

enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment,
                                       human_enrichment = human_enrichment,
                                       alpha = mouse_alpha_seq)

enrichment_PR_AUC <- map_dfr(.x = enrichment_PR, 
                             .f = function(x){
                               tibble(AUC = x[["auc.integral"]], 
                                      prop = x[["true.proportion"]],
                                      n_enriched = prop*nrow(human_enrichment))
                             }, .id = "alpha") %>% 
  mutate(alpha = as.numeric(alpha))

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha_mouse = mouse_alpha_seq)
```

```{r}
enrichment_ROC_AUC <- enrichment_ROC_AUC %>% 
  mutate(NL = round(-log10(alpha), 2))

ggplot(enrichment_ROC_AUC, 
       aes(x = n_enriched, y = AUC)) + 
  geom_line() + 
  geom_point() + 
  geom_ribbon(data = df_ROC_AUC_quantiles, 
              mapping = aes(x = n_enriched, ymin = AUC_lwr, ymax = AUC_upr),
              inherit.aes = FALSE,
              alpha = 0.3, fill = "red") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", col = "red") + 
  coord_cartesian(xlim = c(0, 210),
                  ylim = c(0.4, 1.0)) +
  scale_x_continuous(breaks = seq(0, 300, by = 20),
                     sec.axis = dup_axis(breaks = enrichment_ROC_AUC$n_enriched,
                                         labels = enrichment_ROC_AUC$NL,
                                         name = "Mouse threshold (-log10(q))")) + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) + 
  labs(x = "Number of mouse pathways enriched",
       y = "ROC AUC",
       title = "ROC pathway comparison between human 7-2 and mouse 7-7") + 
  theme_bw()
```

```{r}
enrichment_PR_AUC <- enrichment_PR_AUC %>% 
  mutate(NL = round(-log10(alpha), 2))

plt_H72_M77_PR_AUC <- ggplot(enrichment_PR_AUC, 
                             aes(x = n_enriched, y = AUC)) + 
  geom_line() + 
  geom_point() +
  geom_ribbon(data = df_PR_AUC_quantiles, 
              mapping = aes(x = n_enriched, ymin = AUC_lwr, ymax = AUC_upr),
              inherit.aes = FALSE,
              alpha = 0.3, fill = "red") + 
  geom_line(data = df_PR_AUC_quantiles, 
            mapping = aes(y = AUC_chance),
            linetype = "dashed", col = "red") + 
    coord_cartesian(xlim = c(0, 210)) +
  scale_x_continuous(breaks = seq(0, 300, by = 20),
                     sec.axis = dup_axis(breaks = enrichment_PR_AUC$n_enriched,
                                         labels = enrichment_PR_AUC$NL,
                                         name = "Mouse threshold (-log10(q))")) +
  labs(x = "Number of mouse pathways enriched",
       y = "PR AUC",
       title = "Precision-recall pathway comparison between human 7-2 and mouse 7-7") + 
  theme_bw()

# outfile <- "pathway_comparison_H7-2_M7-7_PR_AUC.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(6, "in"),
#     height = unit(3, "in"))
# print(plt_H72_M77_PR_AUC)
# dev.off()

plt_H72_M77_PR_AUC
```

```{r}
plt_H72_M77_HG <- enrichment_HG %>% 
  ggplot(aes(x = B, y = -log10(pval), col = factor(round(-log10(alpha_human), 2)))) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
  labs(col = "Human threshold (-log10(q))",
       y = "-log10(p)",
       x = "Number of mouse pathways enriched",
       title = "Hypergeometric test pathway comparison between human 7-2 and mouse 7-7") + 
      coord_cartesian(xlim = c(0, 210)) +
  scale_x_continuous(breaks = seq(0, 300, by = 20),
                     sec.axis = dup_axis(breaks = enrichment_PR_AUC$n_enriched,
                                         labels = enrichment_PR_AUC$NL,
                                         name = "Mouse threshold (-log10(q))")) +
  scale_y_continuous(breaks = seq(0, 20, by = 2)) + 
  theme_bw()

# outfile <- "pathway_comparison_H7-2_M7-7_HG.pdf"
# outfile <- file.path(output_dir, outfile)
# pdf(file = outfile,
#     width = unit(8, "in"),
#     height = unit(4, "in"))
# print(plt_H72_M71_HG)
# dev.off()

plt_H72_M77_HG
```

## All matching clusters at 7

```{r}
source(file.path(PROJECTPATH, "src", "analysis.R"))

# Import cluster similarity
similarity <- import_similarity(param_id = 375, 
                                pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Import cluster similarity permutations
permutations <- import_similarity_permutations(param_id = 375,
                                               pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Compute significance of correlations
df_sim_pvals <- compute_similarity_significance(similarity = similarity,
                                                permutations = permutations)
```


```{r}
human_cluster_id <- "7-2"
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_nk <- human_nk
list_mouse_enrichment <- vector(mode = "list", length = mouse_nk)
list_ROC_AUC <- vector(mode = "list", length = mouse_nk)
list_PR_AUC <- vector(mode = "list", length = mouse_nk)
list_HG <- vector(mode = "list", length = mouse_nk)
for (k in 1:mouse_nk) {
  
  mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                              pipeline_dir = mouse_pipeline_dir, 
                                              nk = mouse_nk, k = k)
  
  mouse_enrichment <- mouse_enrichment %>% 
    filter(ID %in% pathway_ids_keep) %>% 
    arrange(ID)
  
  list_mouse_enrichment[[k]] <- mouse_enrichment
  
  mouse_alpha_seq <- 2:10
  mouse_alpha_seq <- (1/10)^mouse_alpha_seq
  mouse_alpha_seq <- c(0.05, mouse_alpha_seq)
  
  enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq)
  
  enrichment_ROC <- enrichment_ROC[!is.na(enrichment_ROC)]
  
  list_ROC_AUC[[k]] <- map_dbl(enrichment_ROC, pROC::auc) %>% 
    enframe(name = "alpha", value = "AUC") %>% 
    mutate(alpha = as.numeric(alpha))
  
  enrichment_PR <- compute_enrichment_PR(mouse_enrichment = mouse_enrichment,
                                       human_enrichment = human_enrichment,
                                       alpha = mouse_alpha_seq)
  
  list_PR_AUC[[k]] <- map_dfr(.x = enrichment_PR, 
                             .f = function(x){
                               tibble(AUC = x[["auc.integral"]], 
                                      Prop = x[["true.proportion"]])
                             }, .id = "alpha") %>% 
  mutate(alpha = as.numeric(alpha))
  
  list_HG[[k]] <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                                  human_enrichment = human_enrichment,
                                                  alpha = mouse_alpha_seq) %>% 
    mutate(k = k)
  
}
```


```{r}
df_ROC_AUC <- bind_rows(list_ROC_AUC, .id = "k") %>% 
  mutate(k = as.numeric(k))

plt_nk7_ROC_AUC <- ggplot(df_ROC_AUC, 
       aes(x = -log10(as.numeric(alpha)), y = AUC, col = factor(k))) + 
  geom_line() + 
  geom_point() + 
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  coord_cartesian(ylim = c(0.4, 1)) + 
  scale_x_continuous(breaks = round(c(-log10(0.05), seq(2.0, 10.0, by = 1)), 2))  + 
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) + 
  labs(x = "Mouse threshold (-log10(q))",
       col = "Mouse cluster",
       title = "ROC pathway comparison between human 7-2 and mouse nk = 7") + 
  theme_bw()

outfile <- "pathway_comparison_nk7_ROC_AUC.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt_nk7_ROC_AUC)
dev.off()
```

```{r}
df_PR_AUC <- bind_rows(list_PR_AUC, .id = "k") %>% 
  mutate(k = as.numeric(k)) %>% 
  filter(!is.na(AUC)) %>% 
  mutate(delta = AUC - Prop)

plt_nk7_PR_AUC <- ggplot(df_PR_AUC, aes(x = -log10(alpha), y = delta, col = factor(k))) + 
    geom_line() + 
  geom_point() + 
  scale_x_continuous(breaks = round(c(-log10(0.05), seq(2.0, 10.0, by = 1)), 2))  + 
  labs(x = "Mouse threshold (-log10(q))",
       y = "Difference from chance level",
       col = "Mouse cluster",
       title = "PR pathway comparison between human 7-2 and mouse nk = 7") + 
  theme_bw()

outfile <- "pathway_comparison_nk7_PR_AUC.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(8, "in"),
    height = unit(4, "in"))
print(plt_nk7_PR_AUC)
dev.off()
```

```{r}
df_mouse_HG <- bind_rows(list_HG)

plt_nk7_HG <- ggplot(df_mouse_HG, 
                     aes(x = -log10(alpha_human), 
                         y = -log10(pval), 
                         col = factor(round(-log10(alpha_mouse), 2)))) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  facet_wrap(~k) + 
  scale_x_continuous(breaks = round(c(-log10(0.05), seq(2.0, 10.0, by = 1)), 2))  + 
  # scale_y_continuous(breaks = seq(0, 20, by = 1)) + 
  labs(x = "Human threshold (-log10(q))",
       col = "Mouse threshold\n(-log10(q))",
       y = "-log10(p)",
       title = "Hypergeometric test pathway comparison between human 7-2 and mouse nk = 7") + 
  theme_bw()

outfile <- "pathway_comparison_nk7_HG.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(10, "in"),
    height = unit(6, "in"))
print(plt_nk7_HG)
dev.off()
```

```{r}
df_sim_pvals %>% 
  filter(img1_cluster_id == "7-2", 
         img2_nk == 7) %>% 
  select(img2_cluster_id, similarity, pval) %>% 
  arrange(pval)
```


```{r}
mouse_pass <- list_mouse_enrichment[[1]]$adj.P.Val < 0.05
human_pass <- human_enrichment$adj.P.Val < 0.05

message(paste("Number of mouse pathways:", sum(mouse_pass)))
message(paste("Number of human pathways:", sum(human_pass)))
message(paste("Number of common pathways:", sum(human_pass & mouse_pass)))
```

```{r}
mouse_pass <- list_mouse_enrichment[[4]]$adj.P.Val < 0.05
human_pass <- human_enrichment$adj.P.Val < 0.05

message(paste("Number of mouse pathways:", sum(mouse_pass)))
message(paste("Number of human pathways:", sum(human_pass)))
message(paste("Number of common pathways:", sum(human_pass & mouse_pass)))
```

```{r}
mouse_pass <- list_mouse_enrichment[[2]]$adj.P.Val < 0.05
human_pass <- human_enrichment$adj.P.Val < 0.05

message(paste("Number of mouse pathways:", sum(mouse_pass)))
message(paste("Number of human pathways:", sum(human_pass)))
message(paste("Number of common pathways:", sum(human_pass & mouse_pass)))
```

```{r}
mouse_pass <- list_mouse_enrichment[[7]]$adj.P.Val < 0.05
human_pass <- human_enrichment$adj.P.Val < 0.05

message(paste("Number of mouse pathways:", sum(mouse_pass)))
message(paste("Number of human pathways:", sum(human_pass)))
message(paste("Number of common pathways:", sum(human_pass & mouse_pass)))
```



## Higher cluster numbers, pre-selected

```{r}
human_cluster_ids <- c("3-1", "4-2", "5-2", "6-6", "7-2", "8-6")

i <- 5

human_cluster_id <- human_cluster_ids[i]
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

matching_clusters <- "data/cross_species/v3/375/matching_clusters.csv"
df_matching_clusters <- read_csv(file.path(PROJECTPATH, matching_clusters),
                                 show_col_types = FALSE)

df_matching_clusters_i <- df_matching_clusters %>% 
  filter(img1_cluster_id == human_cluster_id)

j <- 2

mouse_cluster_id <- df_matching_clusters_i[[j, "img2_cluster_id"]]
mouse_nk <- str_split(mouse_cluster_id, "-")[[1]][1]
mouse_k <- str_split(mouse_cluster_id, "-")[[1]][2]

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = mouse_nk, k = mouse_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids) %>% 
  arrange(ID)

mouse_alpha_seq_auc <- 2:10
mouse_alpha_seq_auc <- (1/10)^mouse_alpha_seq_auc
mouse_alpha_seq_auc <- c(0.05, mouse_alpha_seq_auc)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq_auc)

enrichment_AUC <- map_dbl(enrichment_ROC, pROC::auc)

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq_auc)

head(enrichment_HG)
```

```{r}
enrichment_HG %>% 
  ggplot(aes(x = -log10(alpha_human), y = -log10(pval), col = factor(-log10(alpha_mouse)))) + 
  geom_line() + 
  geom_point() +
  theme_bw()
```


N is the number of genes in the background set, i.e. the set of all genes we're testing against. 
n is the number of genes in the cluster neighbourhood that are also in the background set. This value should be fixed for a given cluster.
B is the number of genes in the target set, i.e. the set of genes associated with the given molecular pathway. This value should be fixed for each pathway.
b is the number of genes in the cluster neighbourhood that are also in the target set. 




## Higher cluster numbers, not pre-selected

```{r}
human_cluster_ids <- c("3-1", "4-2", "5-2", "6-6", "7-2", "8-6")

i <- 5

human_cluster_id <- human_cluster_ids[i]
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

matching_clusters <- "data/cross_species/v3/375/matching_clusters.csv"
df_matching_clusters <- read_csv(file.path(PROJECTPATH, matching_clusters),
                                 show_col_types = FALSE)

df_matching_clusters_i <- df_matching_clusters %>% 
  filter(img1_cluster_id == human_cluster_id)

j <- 2

mouse_cluster_id <- df_matching_clusters_i[[j, "img2_cluster_id"]]
mouse_nk <- str_split(mouse_cluster_id, "-")[[1]][1]
mouse_k <- str_split(mouse_cluster_id, "-")[[1]][2]

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = mouse_nk, k = mouse_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_alpha_seq_auc <- 2:10
mouse_alpha_seq_auc <- (1/10)^mouse_alpha_seq_auc
mouse_alpha_seq_auc <- c(0.05, mouse_alpha_seq_auc)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq_auc)

enrichment_AUC <- map_dbl(enrichment_ROC, pROC::auc)

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq_auc)

head(enrichment_HG)
```

```{r}
enrichment_AUC %>% 
  enframe(name = "alpha", value = "auc") %>% 
  mutate(alpha = as.numeric(alpha)) %>% 
  ggplot(aes(x = -log10(alpha), y = auc)) + 
  geom_line() + 
  geom_point() + 
  coord_cartesian(ylim = c(0.5, 1)) + 
  scale_x_continuous(breaks = seq(2.0, 10.0, by = 1)) + 
  theme_bw()
```

```{r}
list_roc <- vector(mode = "list", length = length(enrichment_ROC))
for (i in 1:length(enrichment_ROC)) {
  list_roc[[i]] <- tibble(tpr = enrichment_ROC[[i]][["sensitivities"]],
                          fpr = 1-enrichment_ROC[[i]][["specificities"]],
                          alpha = as.numeric(names(enrichment_ROC)[i]))
}


df_roc <- bind_rows(list_roc)

df_roc %>% 
  # filter(alpha %in% c(1e-9)) %>%
  ggplot(aes(x = fpr, y = tpr, col = factor(-log10(alpha)))) + 
  annotate(geom = "segment",
           x = 0, xend = 1,
           y = 0, yend = 1,
           size = 0.3,
           linetype = "dashed",
           col = "black") +
  geom_line(size = 0.35) +
  # facet_wrap(~NLQ_mouse_lab, nrow = 2, ncol = 2) + 
  scale_x_continuous(limits = c(0, 1)) + 
  scale_y_continuous(limits = c(0, 1), 
                     expand = expansion(add = 0.1)) + 
  # scale_color_manual(values = pathways_human_palette) + 
  labs(x = "False positive rate",
       y = "True positive rate") +
  theme_bw()
```


```{r}
enrichment_HG %>% 
  ggplot(aes(x = -log10(alpha_human), y = -log10(pval), col = factor(-log10(alpha_mouse)))) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept = -log10(0.05)) + 
  theme_bw()
```

N is the number of genes in the background set, i.e. the set of all genes we're testing against. 
n is the number of genes in the cluster neighbourhood that are also in the background set. This value should be fixed for a given cluster.
B is the number of genes in the target set, i.e. the set of genes associated with the given molecular pathway. This value should be fixed for each pathway.
b is the number of genes in the cluster neighbourhood that are also in the target set. 


## Least matching cluster

```{r}
human_cluster_ids <- c("3-1", "4-2", "5-2", "6-6", "7-2", "8-6")

i <- 5

human_cluster_id <- human_cluster_ids[i]
human_nk <- str_split(human_cluster_id, "-")[[1]][1]
human_k <- str_split(human_cluster_id, "-")[[1]][2]

human_enrichment <- import_enrichment_human(params_id = human_params_id, 
                                            pipeline_dir = human_pipeline_dir, 
                                            nk = human_nk, k = human_k)

source(file.path(PROJECTPATH, "src", "analysis.R"))

# Import cluster similarity
similarity <- import_similarity(param_id = 375, 
                                pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Import cluster similarity permutations
permutations <- import_similarity_permutations(param_id = 375,
                                               pipeline_dir = file.path(PROJECTPATH, "data/cross_species/v3"))

# Compute significance of correlations
df_sim_pvals <- compute_similarity_significance(similarity = similarity,
                                                permutations = permutations)

mouse_cluster_id <- df_sim_pvals %>% 
  filter(img1_cluster_id == human_cluster_id, img2_nk == human_nk) %>% 
  filter(similarity == min(similarity)) %>% 
  pull(img2_cluster_id)

print(mouse_cluster_id)
mouse_nk <- str_split(mouse_cluster_id, "-")[[1]][1]
mouse_k <- str_split(mouse_cluster_id, "-")[[1]][2]

mouse_enrichment <- import_enrichment_mouse(params_id = mouse_params_id, 
                                            pipeline_dir = mouse_pipeline_dir, 
                                            nk = mouse_nk, k = mouse_k)

human_enrichment <- human_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_enrichment <- mouse_enrichment %>% 
  filter(ID %in% pathway_ids_keep) %>% 
  arrange(ID)

mouse_alpha_seq_auc <- 2:10
mouse_alpha_seq_auc <- (1/10)^mouse_alpha_seq_auc
mouse_alpha_seq_auc <- c(0.05, mouse_alpha_seq_auc)

enrichment_ROC <- compute_enrichment_ROC(mouse_enrichment = mouse_enrichment, 
                                         human_enrichment = human_enrichment,
                                         alpha = mouse_alpha_seq_auc)

enrichment_AUC <- map_dbl(enrichment_ROC, pROC::auc)

enrichment_HG <- compute_enrichment_HGtest(mouse_enrichment = mouse_enrichment, 
                                           human_enrichment = human_enrichment,
                                           alpha = mouse_alpha_seq_auc)

head(enrichment_HG)
```

```{r}
enrichment_AUC %>% 
  enframe(name = "alpha", value = "auc") %>% 
  mutate(alpha = as.numeric(alpha)) %>% 
  ggplot()
```


```{r}
list_roc <- vector(mode = "list", length = length(enrichment_ROC))
for (i in 1:length(enrichment_ROC)) {
  list_roc[[i]] <- tibble(tpr = enrichment_ROC[[i]][["sensitivities"]],
                          fpr = 1-enrichment_ROC[[i]][["specificities"]],
                          alpha = as.numeric(names(enrichment_ROC)[i]))
}


df_roc <- bind_rows(list_roc)

df_roc %>% 
  # filter(alpha %in% c(1e-9)) %>%
  ggplot(aes(x = fpr, y = tpr, col = factor(-log10(alpha)))) + 
  annotate(geom = "segment",
           x = 0, xend = 1,
           y = 0, yend = 1,
           size = 0.3,
           linetype = "dashed",
           col = "black") +
  geom_line(size = 0.35) +
  # facet_wrap(~NLQ_mouse_lab, nrow = 2, ncol = 2) + 
  scale_x_continuous(limits = c(0, 1)) + 
  scale_y_continuous(limits = c(0, 1), 
                     expand = expansion(add = 0.1)) + 
  # scale_color_manual(values = pathways_human_palette) + 
  labs(x = "False positive rate",
       y = "True positive rate") +
  theme_bw()
```


```{r}
enrichment_HG %>% 
  ggplot(aes(x = -log10(alpha_human), y = -log10(pval), col = factor(-log10(alpha_mouse)))) + 
  geom_line() + 
  geom_point() +
  geom_hline(yintercept = -log10(0.05)) + 
  theme_bw()
```

N is the number of genes in the background set, i.e. the set of all genes we're testing against. 
n is the number of genes in the cluster neighbourhood that are also in the background set. This value should be fixed for a given cluster.
B is the number of genes in the target set, i.e. the set of genes associated with the given molecular pathway. This value should be fixed for each pathway.
b is the number of genes in the cluster neighbourhood that are also in the target set. 




