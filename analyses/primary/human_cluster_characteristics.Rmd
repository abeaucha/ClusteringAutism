---
title: "Human cluster characteristics"
author: "Antoine Beauchamp"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(RMINC))
```

```{r functions}
source("../../src/utils.R")
source("../../src/processing.R")
# source("../../src/analysis.R")
```


```{r parameters}
#Output directory
output_dir <- "outputs/human_cluster_characteristics/"

#Human directories
version <- "v2"

registration_dir <- "../../data/human/registration/"
registration_dir <- file.path(registration_dir, version)

pipeline_dir <- "../../data/human/derivatives/"
pipeline_dir <- file.path(pipeline_dir, version)

#Human parameters
resolution <- 0.8
es_method <- "normative-growth"
es_df <- 3
cluster_map_method <- "mean"

metadata <- file.path(pipeline_dir, "metadata.csv")
params <- fetch_params_metadata(metadata = metadata,
                                resolution = resolution,
                                es_method = es_method,
                                es_df = es_df,
                                cluster_map_method = cluster_map_method)
params
```



```{r}
#Parameter set ID
params_id <- 700

#Pipeline directory
pipeline_dir <- file.path(pipeline_dir, params_id)

#Cluster resolution
cluster_resolution <- params[["cluster_resolution"]]
cluster_resolution <- sprintf("%.1f", cluster_resolution)

#Cluster directory
cluster_dir <- file.path(pipeline_dir, "clusters", paste0("resolution_", cluster_resolution))

#Output directory
output_dir <- file.path(output_dir, version, params_id)
if (!(dir.exists(output_dir))) {dir.create(output_dir, recursive = TRUE)}
```

```{r}
demographics <- file.path(registration_dir, "subject_info", "demographics.csv")
demographics <- read_csv(demographics, show_col_types = FALSE)
```

```{r}
clusters <- file.path(cluster_dir, "clusters.csv")
clusters <- read_csv(clusters, show_col_types = FALSE)

clusters_vol <- clusters %>% 
  mutate(absolute = 0,
         relative = 0)
```

```{r}
# res <- params[["resolution"]]
res <- 3.0

# mask <- file.path(registration_dir, "reference_files", "mask_0.8mm.mnc")
mask <- file.path(registration_dir, "reference_files", "mask_3.0mm.mnc")

jacobians <- c("absolute", "relative")
jacobians_dir <- file.path(registration_dir, "jacobians_resampled", "resolution_3.0", jacobians)
names(jacobians_dir) <- jacobians

for (j in jacobians) {
  
  imgfiles <- clusters_vol[["ID"]]
  imgfiles <- file.path(jacobians_dir[[j]], imgfiles)
  voxels <- import_images(imgfiles, mask = mask, output_format = "matrix", 
                          inparallel = TRUE, nproc = 4)
  voxels <- (res^3)*exp(voxels)
  volumes <- rowSums(voxels)
  clusters_vol[[j]] <- volumes*(0.1^3)
}
```

```{r}
p_cluster_vol <- ggplot(clusters_vol, aes(x = factor(nk2), y = absolute)) + 
  geom_jitter(col = "grey70") + 
  geom_boxplot(alpha = 0.5) + 
  labs(x = "Cluster ID", 
       y = "Total absolute volume (cm^3)",
       title = "Total brain volume comparison for human 2-cluster solution") + 
  theme_bw()

outfile <- "cluster_volumes_nk2.pdf"
outfile <- file.path(output_dir, outfile)
pdf(file = outfile,
    width = unit(10, "in"),
    height = unit(10, "in"))
print(p_cluster_vol)
dev.off()
```
```{r}
df_model <- clusters_vol %>% 
  select(cluster = nk2, volume = absolute) %>% 
  mutate(cluster = factor(cluster))

summary(lm(volume ~ cluster, data = df_model))
```

```{r}
df_fxs <- demographics %>% 
  filter(DX == "Fragile X")

clusters %>% 
  semi_join(df_fxs, by = c("ID" = "file"))
```

```{r}
mouse_clusters <- "../../data/mouse/derivatives/v2/107/clusters/clusters.csv"
mouse_clusters <- read_csv(mouse_clusters, show_col_types = FALSE)
colnames(mouse_clusters) <- c("ID", str_c("nk", 2:10))

ind_fmr1 <- str_detect(mouse_clusters[["ID"]], "Fmr1")
mouse_clusters[ind_fmr1,]
```

```{r}
genetics <- file.path(registration_dir, "subject_info", "POND_variants.xlsx")
pond_genetics <- read_excel(genetics)

fxs_id <- df_fxs[["Subject_ID"]] %>% 
  str_remove("POND_")

pond_genetics %>% 
  filter(POND_ID == fxs_id)
```

```{r}
fxs_id
```


```{r}
pond_genetics %>%
  pull(POND_ID) %>% 
  sort()
```

