---
title: "Human and mouse cluster similarity"
author: "Antoine Beauchamp"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r packages}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(data.tree))
suppressPackageStartupMessages(library(RMINC))
suppressPackageStartupMessages(library(MRIcrotome))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(RColorBrewer))
suppressPackageStartupMessages(library(grid))
suppressPackageStartupMessages(library(gridExtra))
```

```{r functions}
source("../../src/utils.R")
source("../../src/processing.R")
source("../../src/analysis.R")
source("../../src/tree_tools.R")
```

```{r directories}
#Output directory
output_dir <- "outputs/cluster_similarity/"

#Similarity pipeline
version <- "v2"
pipeline_dir <- "../../data/cross_species/"
pipeline_dir <- file.path(pipeline_dir, version)

#Human parameters
human_resolution <- 0.8
human_es_method <- "normative-growth"
human_es_df <- 3
human_cluster_map_method <- "mean"

#Mouse parameters
mouse_resolution <- 0.2
mouse_cluster_map_method <- human_cluster_map_method

#Similarity parameters
metric <- "correlation"

metadata <- file.path(pipeline_dir, "metadata.csv")
params <- fetch_params_metadata(metadata = metadata,
                                human_resolution = human_resolution,
                                human_es_method = human_es_method,
                                human_es_df = human_es_df,
                                human_cluster_map_method = human_cluster_map_method,
                                metric = metric)
params
```

```{r parameters}
#Parameter set ID
params_id <- 405

#Human parameter set ID
human_params_id <- params %>% 
  filter(id == params_id) %>% 
  pull(human_id)

#Mouse parameter set ID
mouse_params_id <- params %>% 
  filter(id == params_id) %>% 
  pull(mouse_id)

#Pipeline directory
pipeline_dir <- file.path(pipeline_dir, params_id, "similarity")

#Human pipeline directory
human_pipeline_dir <- "../../data/human/derivatives/"
human_pipeline_dir <- file.path(human_pipeline_dir, version, human_params_id)

#Mouse pipeline directory
mouse_pipeline_dir <- "../../data/mouse/derivatives/"
mouse_pipeline_dir <- file.path(mouse_pipeline_dir, "v2", mouse_params_id)

#Output directory
output_dir <- file.path(output_dir, version, params_id)
if (!(dir.exists(output_dir))) {dir.create(output_dir, recursive = TRUE)}
```

```{r import}
jacobians <- c("absolute", "relative")
similarity_files <- list.files(pipeline_dir, full.names = TRUE)
similarity <- vector(mode = "list", length = length(jacobians))
names(similarity) <- jacobians
for (i in 1:length(similarity)) {
  similarity[[i]] <- read_csv(similarity_files[i], show_col_types = FALSE) %>% 
    mutate(human_nk = human_img %>% basename() %>% str_extract("_nk_[0-9]+") %>% str_extract("[0-9]+") %>% as.numeric(),
           human_k = human_img %>% basename() %>% str_extract("_k_[0-9]+") %>% str_extract("[0-9]+") %>% as.numeric(),
           mouse_nk = mouse_img %>% basename() %>% str_extract("_nk_[0-9]+") %>% str_extract("[0-9]+") %>% as.numeric(),
           mouse_k = mouse_img %>% basename() %>% str_extract("_k_[0-9]+") %>% str_extract("[0-9]+") %>% as.numeric()) %>% 
    unite(col = "human_cluster_id", human_nk, human_k, sep = "-", remove = FALSE) %>% 
    unite(col = "mouse_cluster_id", mouse_nk, mouse_k, sep = "-", remove = FALSE)
}
```

# Mouse-human cluster similarity


```{r similarity-matrices}
nk_max <- params[["human_cluster_nk_max"]]

heatmap_colours <- rev(brewer.pal(n = 7, name = "RdYlBu"))
palette_length <- 255
heatmap_palette <- colorRampPalette(heatmap_colours)(palette_length)

for (nk in 2:nk_max) {
  similarity_nk <- vector(mode = "list", length = length(similarity))
  names(similarity_nk) <- names(similarity)
  for (i in 1:length(similarity_nk)) {
    df_sim <- similarity[[i]] %>% 
      filter(human_nk == nk,
             mouse_nk == nk) %>% 
      mutate(human_cluster_id = factor(human_cluster_id, 
                                       levels = sort(unique(human_cluster_id))),
             mouse_cluster_id = factor(mouse_cluster_id, 
                                       levels = sort(unique(mouse_cluster_id))))
    
    similarity_nk[[i]] <- df_sim
    
    heatmap_range <- c(min(df_sim[["similarity"]]), max(df_sim[["similarity"]]))
    heatmap_range_dist <- heatmap_range[2] - heatmap_range[1]
    
    heatmap_breaks <- seq(heatmap_range[1], heatmap_range[2], length.out = palette_length)
    
    p_sim <- ggplot(df_sim, 
                    aes(x = human_cluster_id, 
                        y = fct_rev(mouse_cluster_id), 
                        fill = similarity)) + 
      geom_tile(col = "grey50") + 
      labs(x = "Human clusters",
           y = "Mouse clusters",
           fill = metric,
           title = paste("Similarity based on", jacobians[i], "effect sizes")) + 
      scale_fill_gradientn(colors = heatmap_palette) +
      scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
      scale_y_discrete(expand = expansion(mult = 0)) + 
      theme_bw() + 
      theme(axis.ticks = element_blank())
    
    outfile <- paste0("similarity_matrix_nk_", nk, "_", jacobians[i], ".pdf")
    outfile <- file.path(output_dir, outfile)
    pdf(file = outfile, 
        width = unit(10, "in"),
        height = unit(8, "in"))
    print(p_sim)
    dev.off()
    
  }
  
  df_sim_combined <- bind_rows(similarity_nk[["absolute"]] %>% 
                                 mutate(jacobians = "absolute"),
                               similarity_nk[["relative"]] %>% 
                                 mutate(jacobians = "relative")) %>% 
    group_by(human_cluster_id, mouse_cluster_id) %>% 
    summarise(similarity = mean(similarity), .groups = "drop")
  
  p_sim_combined <- ggplot(df_sim_combined, 
                           aes(x = human_cluster_id, 
                               y = fct_rev(mouse_cluster_id), 
                               fill = similarity)) + 
    geom_tile(col = "grey50") + 
    labs(x = "Human clusters",
         y = "Mouse clusters",
         fill = metric,
         title = "Combined similarity matrices") + 
    scale_fill_gradientn(colors = heatmap_palette) +
    scale_x_discrete(expand = expansion(mult = 0), position = "top") + 
    scale_y_discrete(expand = expansion(mult = 0)) + 
    theme_bw() + 
    theme(axis.ticks = element_blank())
  
  outfile <- paste0("similarity_matrix_nk_", nk, "_combined.pdf")
  outfile <- file.path(output_dir, outfile)
  pdf(file = outfile, 
      width = unit(10, "in"),
      height = unit(8, "in"))
  print(p_sim_combined)
  dev.off()
}
```


# Mouse and human cluster centroid maps

```{r}
nk_mouse <- 4
k_mouse <- 4

nk_human <- 4
k_human <- 4
```

```{r}
mouse_anat_file <- "../../data/mouse/atlas/DSURQE_CCFv3_average_200um.mnc"
mouse_anat <- mincGetVolume(mouse_anat_file)
mouse_anat_vol <- mincArray(mouse_anat)

#Human anatomy
human_anat_file <- "../../data/human/registration/v1/reference_files/model_0.8mm.mnc"
human_anat <- mincGetVolume(human_anat_file)
human_anat_vol <- mincArray(human_anat)

#Cropped human images along sagittal and transverse planes
human_slices_dim_1 <- 25:200
human_slices_dim_3 <- 25:220
human_anat_vol_cropped <- human_anat_vol[human_slices_dim_1,,human_slices_dim_3]

#Human mask
human_mask <- "../../data/human/registration/v1/reference_files/mask_0.8mm.mnc"

#Mouse mask
mouse_mask <- "../../data/mouse/atlas/coronal_200um_coverage_bin0.8.mnc"
```

```{r}
#Human cluster map directories
human_cluster_map_dirs <- file.path(human_pipeline_dir, "cluster_maps")
human_cluster_map_dirs <- file.path(human_cluster_map_dirs, str_c("resolution_", human_resolution))
human_cluster_map_dirs <- file.path(human_cluster_map_dirs, jacobians)
names(human_cluster_map_dirs) <- jacobians

#Mouse cluster map directories
mouse_cluster_map_dirs <- file.path(mouse_pipeline_dir, "cluster_maps")
mouse_cluster_map_dirs <- file.path(mouse_cluster_map_dirs, str_c("resolution_", mouse_resolution))
mouse_cluster_map_dirs <- file.path(mouse_cluster_map_dirs, jacobians)
names(mouse_cluster_map_dirs) <- jacobians  
```

```{r}
signed <- params %>% 
  filter(id == params_id) %>% 
  pull(signed)

threshold <- params %>% 
  filter(id == params_id) %>% 
  pull(threshold)

threshold_value <- params %>% 
  filter(id == params_id) %>% 
  pull(threshold_value)

threshold_symmetric <- params %>% 
  filter(id == params_id) %>% 
  pull(threshold_symmetric)
```

```{r fig.height = 10, fig.width = 3}
list_human_clusters <- vector(mode = "list", length = length(jacobians))
for (i in 1:length(list_human_clusters)) {
  list_human_clusters[[i]] <-  import_cluster_map(imgdir = human_cluster_map_dirs[[i]],
                                                  mask = human_mask,
                                                  nk = nk_human, k = k_human,
                                                  threshold = threshold,
                                                  threshold_value = threshold_value,
                                                  threshold_symmetric = threshold_symmetric)
}

human_overlay_low <- numeric(length(list_human_clusters)) 
human_overlay_high <- numeric(length(list_human_clusters)) 
for (i in 1:length(list_human_clusters)) {
  x <- list_human_clusters[[i]]
  human_overlay_low[i] <- min(abs(x[x != 0]))
  human_overlay_high[i] <- max(abs(x[x != 0]))
}

human_overlay_low <- min(human_overlay_low)
human_overlay_high <- 0.8*max(human_overlay_high)

human_overlay_low <- round(human_overlay_low, 2)
human_overlay_high <- round(human_overlay_high, 2)

ss_human_grob <- sliceSeries(nrow = 10, ncol = 1, begin = 50, end = 200) %>% 
  anatomy(human_anat_vol_cropped, low = 3, high = 7) %>% 
  overlay(mincArray(list_human_clusters[[1]])[human_slices_dim_1,,human_slices_dim_3], 
          low = human_overlay_low, high = human_overlay_high, symmetric = TRUE) %>% 
  addtitle(jacobians[1]) %>% 
  sliceSeries() %>% anatomy() %>%
  overlay(mincArray(list_human_clusters[[2]])[human_slices_dim_1,,human_slices_dim_3], 
          low = human_overlay_low, high = human_overlay_high, symmetric = TRUE) %>% 
  addtitle(jacobians[2]) %>% 
  legend("Effect size") %>% 
  grobify()
```

```{r fig.height = 10, fig.width = 4}
list_mouse_clusters <- vector(mode = "list", length = length(jacobians))
for (i in 1:length(list_mouse_clusters)) {
  list_mouse_clusters[[i]] <-  import_cluster_map(imgdir = mouse_cluster_map_dirs[[i]],
                                                  mask = mouse_mask,
                                                  nk = nk_mouse, k = k_mouse,
                                                  threshold = threshold,
                                                  threshold_value = threshold_value,
                                                  threshold_symmetric = threshold_symmetric)
}

mouse_overlay_low <- numeric(length(list_mouse_clusters)) 
mouse_overlay_high <- numeric(length(list_mouse_clusters)) 
for (i in 1:length(list_mouse_clusters)) {
  x <- list_mouse_clusters[[i]]
  mouse_overlay_low[i] <- min(abs(x[x != 0]))
  mouse_overlay_high[i] <- max(abs(x[x != 0]))
}

mouse_overlay_low <- min(mouse_overlay_low)
mouse_overlay_high <- 0.8*max(mouse_overlay_high)

mouse_overlay_low <- round(mouse_overlay_low, 2)
mouse_overlay_high <- round(mouse_overlay_high, 2)


ss_mouse_grob <- sliceSeries(nrow = 10, ncol = 1, begin = 10, end = 50) %>% 
  anatomy(mouse_anat_vol, low = 700, high = 1400) %>% 
  overlay(mincArray(list_mouse_clusters[[1]]), 
          low = mouse_overlay_low, high = mouse_overlay_high, symmetric = TRUE) %>% 
  addtitle(jacobians[1]) %>% 
  sliceSeries() %>% anatomy() %>%
  overlay(mincArray(list_mouse_clusters[[2]]), 
          low = mouse_overlay_low, high = mouse_overlay_high, symmetric = TRUE) %>% 
  addtitle(jacobians[2]) %>% 
  legend("Effect size") %>% 
  grobify()
```

```{r fig.width = 10, fig.height = 10}
ss_grob <- arrangeGrob(ss_human_grob, ss_mouse_grob,
                       layout_matrix = rbind(c(1,2)),
                       widths = unit(c(0.45, 0.55), 'npc'))

grid.newpage()
grid.draw(ss_grob)
```

# Mouse and human polar plots

```{r}
#Import mouse atlas labels
mouse_labels_file <- "../../data/mouse/atlas/DSURQE_CCFv3_labels_200um.mnc"
mouse_labels <- mincGetVolume(mouse_labels_file)

#Import mouse atlas definitions
mouse_defs_file <- "../../data/mouse/atlas/DSURQE_40micron_R_mapping_long.csv"
mouse_defs <- read_csv(mouse_defs_file, show_col_types = FALSE) %>% 
  select(name = Structure, label = Label)

#Import mouse neuroanatomical tree
mouse_tree_file <- "../../data/mouse/expression/MouseExpressionTree_DSURQE.RData"
load(mouse_tree_file)
mouse_tree <- Clone(treeMouseExpr)
rm(treeMouseExpr)

#Import human microarray atlas labels
human_labels_file <- str_c("AHBA_microarray_labels_study_", version, "_", human_resolution, "mm.mnc")
human_labels_file <- file.path("../../data/human/expression/", human_labels_file)
human_labels <- mincGetVolume(human_labels_file)
human_labels <- round(human_labels)

#Import human microarray atlas definitions
human_defs_file <- "../../data/human/expression/AHBA_microarray_coordinates_mni_defs.csv"
human_defs <- read_csv(human_defs_file, show_col_types = FALSE)

#Import human neuroanatomical tree
human_tree_file <- "../../data/human/expression/HumanExpressionTree.RData"
load(human_tree_file)
human_tree <- Clone(treeHumanExpr)
rm(treeHumanExpr)

#Import mapping for mouse-human neuroanatomical homologues
neuro_file <- "../../data/cross_species/MouseHumanMatches_H10M09.csv"
df_spokes <- read_csv(neuro_file, show_col_types = FALSE)
colnames(df_spokes) <- str_to_lower(colnames(df_spokes))
df_spokes <- df_spokes %>% 
  filter(!(name %in% c("White matter", "Ventricles")))
```

```{r}
#Cluster map directories
cluster_dirs_abs <- c("human" = human_cluster_map_dirs[[1]], 
                      "mouse" = mouse_cluster_map_dirs[[1]])

cluster_dirs_rel <- c("human" = human_cluster_map_dirs[[2]], 
                      "mouse" = mouse_cluster_map_dirs[[2]])

#Human and mouse trees
trees <- list("human" = human_tree,
              "mouse" = mouse_tree)

#Human and mouse labels
labels <- list("human" = human_labels,
               "mouse" = mouse_labels)

#Human and mouse definitions
defs <- list("human" = human_defs,
             "mouse" = mouse_defs)

#Human and mouse masks
masks <- list("human" = human_mask,
              "mouse" = mouse_mask)

#Human and mouse nk
nk <- list("human" = nk_human,
           "mouse" = nk_mouse)

#Human and mouse k
k <- list("human" = k_human,
          "mouse" = k_mouse)

# Prepare radar chart data
radar_abs <- prepare_radar_chart(cluster_dirs = cluster_dirs_abs,
                                 nk = nk, k = k,
                                 trees = trees,
                                 spokes = df_spokes,
                                 labels = labels,
                                 defs = defs,
                                 masks = masks,
                                 threshold = threshold,
                                 threshold_value = threshold_value,
                                 threshold_symmetric = threshold_symmetric)

radar_abs <- radar_abs %>% 
  mutate(positive = ifelse(is.nan(positive), 0, positive))

radar_rel <- prepare_radar_chart(cluster_dirs = cluster_dirs_rel,
                                 nk = nk, k = k,
                                 trees = trees,
                                 spokes = df_spokes,
                                 labels = labels,
                                 defs = defs,
                                 masks = masks,
                                 threshold = threshold,
                                 threshold_value = threshold_value,
                                 threshold_symmetric = threshold_symmetric)

radar_rel <- radar_rel %>% 
  mutate(positive = ifelse(is.nan(positive), 0, positive))
```

```{r}
#Data for line at 0
radar_zeroline <- tibble(name = unique(radar_abs$name),
                         y = 0)

#Plot parameters
nspokes <- length(unique(radar_abs$name))-1
radar_start <- -(2*pi)/nspokes
breaks_start <- -1
breaks_end <- 1
breaks_step <- 0.5
radar_breaks <- seq(breaks_start, breaks_end, by = breaks_step)
radar_labels <- tibble(name = levels(radar_abs$name)[6],
                       breaks = radar_breaks)
```

```{r}
p_radar_abs <- ggplot(radar_abs,
                      aes(x = name, 
                          ymin = negative, 
                          ymax = positive, 
                          group = species, 
                          fill = species,
                          col = species)) + 
  geom_ribbon(alpha = 0.2) +
  geom_line(data = radar_zeroline,
            inherit.aes = FALSE,
            mapping = aes(x = name, y = y, group = 1),
            linetype = "dashed",
            size = 0.5) + 
  geom_text(data = radar_labels,
            inherit.aes = FALSE,
            mapping = aes(x = name,
                          y = breaks,
                          label = breaks),
            size = 2.5,
            nudge_y = 0.1) + 
  coord_radar(start = radar_start) +
  scale_x_discrete(expand = expansion(),
                   labels = c("CbN", "Cx", "CxN", "IB", "MB", "P", "MY", "CbCx", "CbN")) + 
  scale_y_continuous(breaks = seq(-1, 1, by = 0.5), limits = c(-1, 1.2)) +
  scale_fill_discrete(labels = c("Human", "Mouse")) + 
  scale_color_discrete(labels = c("Human", "Mouse")) + 
  labs(x = NULL,
       fill = NULL, 
       col = NULL,
       title = "Absolute effect sizes") + 
  theme_bw() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x = element_text(size = 6, face = "bold"),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        plot.margin = margin(t = 0, b = 0, r = 0, l = 0))
```

```{r}
p_radar_rel <- ggplot(radar_rel,
                      aes(x = name, 
                          ymin = negative, 
                          ymax = positive, 
                          group = species, 
                          fill = species,
                          col = species)) + 
  geom_ribbon(alpha = 0.2) +
  geom_line(data = radar_zeroline,
            inherit.aes = FALSE,
            mapping = aes(x = name, y = y, group = 1),
            linetype = "dashed",
            size = 0.5) + 
  geom_text(data = radar_labels,
            inherit.aes = FALSE,
            mapping = aes(x = name,
                          y = breaks,
                          label = breaks),
            size = 2.5,
            nudge_y = 0.1) + 
  coord_radar(start = radar_start) +
  scale_x_discrete(expand = expansion(),
                   labels = c("CbN", "Cx", "CxN", "IB", "MB", "P", "MY", "CbCx", "CbN")) + 
  scale_y_continuous(breaks = seq(-1, 1, by = 0.5), limits = c(-1, 1.2)) +
  scale_fill_discrete(labels = c("Human", "Mouse")) + 
  scale_color_discrete(labels = c("Human", "Mouse")) + 
  labs(x = NULL,
       fill = NULL, 
       col = NULL,
       title = "Relative effect sizes") + 
  theme_bw() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x = element_text(size = 6, face = "bold"),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        plot.margin = margin(t = 0, b = 0, r = 0, l = 0))
```

```{r}
(p_radar_abs | p_radar_rel) +
  plot_annotation(title = "Neuroanatomical composition of cluster centroid images")
```

