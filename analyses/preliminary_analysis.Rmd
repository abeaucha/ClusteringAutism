---
title: "Preliminary analysis"
author: "Antoine Beauchamp"
date: '2022-06-07'
output: 
  html_document:
    theme: paper
    highlight: pygment
    toc: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(RMINC))
suppressPackageStartupMessages(library(ggalluvial))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(pheatmap))
suppressPackageStartupMessages(library(RColorBrewer))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(viridisLite))
suppressPackageStartupMessages(library(ggplotify))
```

# Mouse and human cluster sankey plots

```{r}
cluster_file_human <- '../data/human/clustering/human_clusters_groups10_3.0mm.csv'
cluster_file_mouse <- '../data/mouse/clustering/mouse_clusters_groups10_200um.csv'

human_cluster_ids <- suppressMessages(read_csv(cluster_file_human))
mouse_cluster_ids <- suppressMessages(read_csv(cluster_file_mouse))

colnames(mouse_cluster_ids) <- colnames(human_cluster_ids)

mouse_cluster_ids_long <- mouse_cluster_ids %>% 
  pivot_longer(cols = -ID, names_to = 'nk_name', values_to = 'k') %>% 
  mutate(nk = str_extract(nk_name, '[0-9]+'),
         nk = as.numeric(nk),
         nk = factor(nk, levels = 2:10),
         k = factor(k, levels = 1:10))

human_cluster_ids_long <- human_cluster_ids %>% 
  pivot_longer(cols = -ID, names_to = 'nk_name', values_to = 'k') %>% 
  mutate(nk = str_extract(nk_name, '[0-9]+'),
         nk = as.numeric(nk),
         nk = factor(nk, levels = 2:10),
         k = factor(k, levels = 1:10))
```

```{r fig.height = 8, fig.width = 10}
p_alluvial_human <- ggplot(human_cluster_ids_long,
                           aes(x = nk,
                               stratum = k,
                               alluvium = ID,
                               fill = k,
                               label = k)) +
  geom_flow(stat = 'alluvium', aes.flow = 'forward') +
  geom_stratum(alpha = 0.5) +
  labs(x = 'Number of clusters',
       y = 'Number of patients',
       title = 'Human clustering dispersion') + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
        panel.grid.major.x = element_blank())

p_alluvial_mouse <- ggplot(mouse_cluster_ids_long,
                           aes(x = nk,
                               stratum = k,
                               alluvium = ID,
                               fill = k,
                               label = k)) +
  geom_flow(stat = 'alluvium', aes.flow = 'forward') +
  geom_stratum(alpha = 0.5) +
  labs(x = 'Number of clusters',
       y = 'Number of mouse models',
       title = 'Mouse clustering dispersion') + 
  theme_bw() + 
  theme(panel.grid.major.x = element_blank())

p_alluvial_human / p_alluvial_mouse + 
  plot_layout(guides = 'collect')
```

# Human voxel-wise representative cluster maps

## Plotting functions and other

```{r}
source('/projects/abeauchamp/Functions/ggsliceseries/ggsliceseries.R')

prepare_cluster_maps <- function(imgfiles, anat, mask, slices = NULL, dimension = 2, clamp = NULL, threshold = NULL, symmetric = FALSE) {
  
  mask_vol <- mincArray(mincGetVolume(mask))
  anat_vol <- mincArray(mincGetVolume(anat))
  
  nmaps <- length(imgfiles)
  
  list_cluster <- vector(mode = 'list', length = nmaps)
  for (i in 1:length(list_cluster)) {
    cluster_vol <- mincArray(mincGetVolume(imgfiles[i]))
    
    nk <- imgfiles[i] %>% 
      basename() %>% 
      str_extract('Clusternum_[0-9]+') %>% 
      str_extract('[0-9]+')
    
    k <- imgfiles[i] %>% 
      basename() %>% 
      str_extract('Group_[0-9]+') %>% 
      str_extract('[0-9]+')
    
    value_name <- str_c(nk, k, sep = '-')
    
    df_cluster <- prepare_overlay_data(vol = cluster_vol,
                                       slices = slices,
                                       dimension = dimension,
                                       mask = mask_vol,
                                       value_name = value_name,
                                       threshold = threshold,
                                       symmetric = symmetric)
    
    list_cluster[[i]] <- df_cluster
  }
  
  df_ss <- combine_slice_data(x = list_cluster)
  
  df_anat <- prepare_data(vol = anat_vol,
                          slices = slices,
                          dimension = dimension,
                          mask = mask_vol,
                          value_name = 'intensity',
                          clamp = clamp)
  
  df_ss <- combine_slice_data(x = list(df_anat, df_ss))
  
  df_ss <- df_ss %>% 
    pivot_longer(cols = c(-x, -y, -intensity, -slice), names_to = 'cluster_id', values_to = 'overlay') %>% 
    separate(col = cluster_id, into = c('nk', 'k')) %>% 
    mutate(nk = as.numeric(nk),
           k = as.numeric(k),
           nk_name = paste('nk =', nk),
           k_name = paste('k =', k))
  
  nk_levels <- df_ss %>% 
    select(nk, nk_name) %>% 
    distinct() %>% 
    arrange(nk) %>% 
    pull(nk_name)
  
  k_levels <- df_ss %>% 
    select(k, k_name) %>% 
    distinct() %>% 
    arrange(k) %>% 
    pull(k_name)
  
  df_ss <- df_ss %>% 
    mutate(nk_name = factor(nk_name, levels = nk_levels),
           k_name = factor(k_name, levels = k_levels))
  
  return(df_ss)
  
}
```

```{r}
anatfile <- '../data/human/registration/reference_files/model_3.0mm.mnc'
maskfile <- '../data/human/registration/reference_files/mask_3.0mm.mnc'

default_palette <- c(colorRampPalette(c("turquoise1", "blue"))(100),
                     colorRampPalette(c("red", "yellow"))(100))

#RColorBrewer scale
# scale_fill_distiller(na.value = 'transparent',
#                      palette = 'RdYlBu',
#                      limits = c(-2,2))

#Custom scale with MRIcrotome colours
# scale_fill_gradientn(colours = default_palette, 
#                      limits = c(-2,2),
#                      na.value = 'transparent')
```

## Absolute jacobian effect sizes

### Representative map in one slice across all cluster solutions

```{r fig.width = 20, fig.height = 20}
imgdir <- '../data/human/clustering/cluster_maps/absolute/resolution_3.0/mean/'
imgfiles <- list.files(imgdir, full.names = T)
df_cluster_maps_abs <- prepare_cluster_maps(imgfiles = imgfiles,
                                            anat = anatfile, mask = maskfile)

ggplot(df_cluster_maps_abs, aes(x = x, y = y)) + 
  geom_raster(aes(fill = intensity)) +
  facet_grid(k_name~nk_name) +
  scale_fill_gradient(low = gray.colors(255)[1],
                      high = gray.colors(255)[255],
                      na.value = 'transparent',
                      guide = 'none') + 
  new_scale_fill() + 
  geom_raster(aes(fill = overlay)) + 
  scale_fill_viridis_c(option = 'cividis',
                       na.value = 'transparent',
                       limits = c(-2,2)) +
  coord_fixed() +
  labs(title = paste0("Mean cluster map for absolute jacobian effect sizes\n", 
                      "Maps are not thresholded."),
       fill = 'Effect size') + 
  theme_bw() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

```{r fig.width = 20, fig.height = 20}
df_cluster_maps_abs <- prepare_cluster_maps(imgfiles = imgfiles,
                                            anat = anatfile, mask = maskfile, threshold = c(0.5, 2), symmetric = TRUE)

ggplot(df_cluster_maps_abs, aes(x = x, y = y)) + 
  geom_raster(aes(fill = intensity)) +
  facet_grid(k_name~nk_name) +
  scale_fill_gradient(low = gray.colors(255)[1],
                      high = gray.colors(255)[255],
                      na.value = 'transparent',
                      guide = 'none') + 
  new_scale_fill() + 
  geom_raster(aes(fill = overlay)) + 
  scale_fill_viridis_c(option = 'plasma',
                       na.value = 'transparent',
                       limits = c(-2,2)) +
  coord_fixed() +
  labs(title = paste0("Mean cluster map for absolute jacobian effect sizes\n", 
                      "Symmetric threshold at [0.5, 2]."),
       fill = 'Effect size') + 
  theme_bw() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

### Cluster map slice series for 9-cluster solution


```{r fig.width = 20, fig.height = 20}
imgfiles <- list.files(imgdir, full.names = T) %>% 
  str_subset('Clusternum_9')

# minc.dimensions.sizes(anatfile)

slices <- seq(14, 60, length.out = 10)

df_cluster_maps_abs_nk9 <- prepare_cluster_maps(imgfiles = imgfiles, anat = anatfile, mask = maskfile, 
                                                slices = slices, threshold = c(0.5, 2), symmetric = TRUE)

ggplot(df_cluster_maps_abs_nk9, aes(x = x, y = y)) + 
  geom_raster(aes(fill = intensity)) +
  facet_grid(slice~k_name) +
  scale_fill_gradient(low = gray.colors(255)[1],
                      high = gray.colors(255)[255],
                      na.value = 'transparent',
                      guide = 'none') + 
  new_scale_fill() + 
  geom_raster(aes(fill = overlay)) + 
  scale_fill_viridis_c(option = 'plasma',
                       na.value = 'transparent',
                       limits = c(-2,2)) +
  coord_fixed() +
  labs(title = paste0("Mean cluster maps for absolute jacobian effect sizes in nk = 9 solution\n", 
                      "Symmetric threshold at [0.5, 2]."),
       fill = 'Effect size') + 
  theme_bw() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```


## Relative jacobian effect sizes

### Representative map in one slice across all cluster solutions

```{r fig.width = 20, fig.height = 20}
imgdir <- '../data/human/clustering/cluster_maps/relative/resolution_3.0/mean/'
imgfiles <- list.files(imgdir, full.names = T)
df_cluster_maps_abs <- prepare_cluster_maps(imgfiles = imgfiles,
                                            anat = anatfile, mask = maskfile)

ggplot(df_cluster_maps_abs, aes(x = x, y = y)) + 
  geom_raster(aes(fill = intensity)) +
  facet_grid(k_name~nk_name) +
  scale_fill_gradient(low = gray.colors(255)[1],
                      high = gray.colors(255)[255],
                      na.value = 'transparent',
                      guide = 'none') + 
  new_scale_fill() + 
  geom_raster(aes(fill = overlay)) + 
  scale_fill_viridis_c(option = 'cividis',
                       na.value = 'transparent',
                       limits = c(-2,2)) +
  coord_fixed() +
  labs(title = paste0("Mean cluster map for relative jacobian effect sizes\n", 
                      "Maps are not thresholded."),
       fill = 'Effect size') + 
  theme_bw() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

```{r fig.width = 20, fig.height = 20}
df_cluster_maps_abs <- prepare_cluster_maps(imgfiles = imgfiles,
                                            anat = anatfile, mask = maskfile, threshold = c(0.5, 2), symmetric = TRUE)

ggplot(df_cluster_maps_abs, aes(x = x, y = y)) + 
  geom_raster(aes(fill = intensity)) +
  facet_grid(k_name~nk_name) +
  scale_fill_gradient(low = gray.colors(255)[1],
                      high = gray.colors(255)[255],
                      na.value = 'transparent',
                      guide = 'none') + 
  new_scale_fill() + 
  geom_raster(aes(fill = overlay)) + 
  scale_fill_viridis_c(option = 'plasma',
                       na.value = 'transparent',
                       limits = c(-2,2)) +
  coord_fixed() +
  labs(title = paste0("Mean cluster map for relative jacobian effect sizes\n", 
                      "Symmetric threshold at [0.5, 2]."),
       fill = 'Effect size') + 
  theme_bw() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

### Cluster map slice series for 9-cluster solution


```{r fig.width = 20, fig.height = 20}
imgfiles <- list.files(imgdir, full.names = T) %>% 
  str_subset('Clusternum_9')

# minc.dimensions.sizes(anatfile)

slices <- seq(14, 60, length.out = 10)

df_cluster_maps_abs_nk9 <- prepare_cluster_maps(imgfiles = imgfiles, anat = anatfile, mask = maskfile, 
                                                slices = slices, threshold = c(0.5, 2), symmetric = TRUE)

ggplot(df_cluster_maps_abs_nk9, aes(x = x, y = y)) + 
  geom_raster(aes(fill = intensity)) +
  facet_grid(slice~k_name) +
  scale_fill_gradient(low = gray.colors(255)[1],
                      high = gray.colors(255)[255],
                      na.value = 'transparent',
                      guide = 'none') + 
  new_scale_fill() + 
  geom_raster(aes(fill = overlay)) + 
  scale_fill_viridis_c(option = 'plasma',
                       na.value = 'transparent',
                       limits = c(-2,2)) +
  coord_fixed() +
  labs(title = paste0("Mean cluster maps for relative jacobian effect sizes in nk = 9 solution\n", 
                      "Symmetric threshold at [0.5, 2]."),
       fill = 'Effect size') + 
  theme_bw() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

# Mouse-human cluster similarity


```{r}
source('../functions/buildSimilarityMatrix.R')

process_signatures <- function(file){
  suppressMessages(read_csv(file)) %>% 
    mutate(nk = clusterfile %>% 
             str_extract('Clusternum_[0-9]+') %>% 
             str_extract('[0-9]+') %>% 
             as.numeric(),
           k = clusterfile %>% 
             str_extract('Group_[0-9]+') %>% 
             str_extract('[0-9]+') %>% 
             as.numeric()) %>% 
    arrange(nk, k) %>% 
    select(-exprfile, -clusterfile) %>% 
    unite(col = 'cluster_id', nk, k, sep = '-') %>% 
    column_to_rownames('cluster_id') %>% 
    as.matrix() %>% 
    t() 
}

generate_heatmap <- function(x, palette) {
  
  df_annotations <- tibble(cluster_ids = colnames(x)) %>% 
    separate(cluster_ids, into = c('nk', 'k'), remove = FALSE) %>% 
    mutate(nk = factor(nk, levels = 1:10),
           k = factor(k, levels = 1:10)) %>% 
    column_to_rownames(var = 'cluster_ids')
  
  df_colour_palette <- tibble(i = factor(1:10),
                              colour = palette)
  
  df_annotation_colours <- df_annotations %>% 
    left_join(df_colour_palette, by = c('nk' = 'i')) %>% 
    rename(nk_col = colour) %>% 
    left_join(df_colour_palette, by = c('k' = 'i')) %>% 
    rename(k_col = colour) 
  
  nk_colours <- df_annotation_colours$nk_col
  names(nk_colours) <- df_annotation_colours$nk
  
  k_colours <- df_annotation_colours$k_col
  names(k_colours) <- df_annotation_colours$k
  
  annotation_colours <- list(nk = nk_colours,
                             k = k_colours)
  
  p <- pheatmap(x, 
                cluster_cols = F, cluster_rows = F, 
                annotation_row = df_annotations,
                annotation_col = df_annotations,
                annotation_colors = annotation_colours, 
                silent = TRUE, 
                na_col = 'black')
  
  return(p)
}
```


```{r}
threshold <- 0.9

mouse_file <- str_c('../data/mouse/cluster_signatures/input_space/mouse_cluster_signatures_abs_mean_threshold', threshold, '_inputspace.csv')
human_file <- str_c('../data/human/cluster_signatures/input_space/human_cluster_signatures_abs_mean_threshold',
threshold, '_inputspace.csv')

mat_mouse <- process_signatures(mouse_file)
mat_human <- process_signatures(human_file)

mat_sim <- buildSimilarityMatrix(x1 = mat_human,
                                 x2 = mat_mouse,
                                 method = 'correlation')

# palette <- colorRampPalette(colors = brewer.pal(n = 9, name = 'Blues'))(10)
palette <- mako(n = 10, direction = -1, begin = 0.3)

p_abs_inputspace <- as.ggplot(generate_heatmap(x = mat_sim, palette = palette)) +
  labs(title = 'Absolute jacobian signatures with input space')


mouse_file <- str_c('../data/mouse/cluster_signatures/input_space/mouse_cluster_signatures_rel_mean_threshold', threshold, '_inputspace.csv')
human_file <- str_c('../data/human/cluster_signatures/input_space/human_cluster_signatures_rel_mean_threshold', threshold, '_inputspace.csv')

mat_mouse <- process_signatures(mouse_file)
mat_human <- process_signatures(human_file)

mat_sim <- buildSimilarityMatrix(x1 = mat_human,
                                 x2 = mat_mouse,
                                 method = 'correlation')

p_rel_inputspace <- as.ggplot(generate_heatmap(x = mat_sim, palette = palette)) +
  labs(title = 'Relative jacobian signatures with input space')


latent_space_file <- str_c('../data/similarity/latent_space_100/similarity_hm_abs_mean_threshold',threshold, '_latentspace100.csv')

mat_sim <- suppressMessages(read_csv(latent_space_file)) %>% 
  column_to_rownames('cluster_id') %>% 
  as.matrix()

p_abs_latentspace <- as.ggplot(generate_heatmap(x = mat_sim, palette = palette)) +
  labs(title = 'Absolute jacobian signatures with latent space')


latent_space_file <- str_c('../data/similarity/latent_space_100/similarity_hm_rel_mean_threshold', threshold, '_latentspace100.csv')

mat_sim <- suppressMessages(read_csv(latent_space_file)) %>% 
  column_to_rownames('cluster_id') %>% 
  as.matrix()

p_rel_latentspace <- as.ggplot(generate_heatmap(x = mat_sim, palette = palette)) +
  labs(title = 'Relative jacobian signatures with latent space')

```

```{r fig.width = 20, fig.height = 20}
patchwork_plot <- (p_abs_inputspace | p_rel_inputspace) / (p_abs_latentspace | p_rel_latentspace)
patchwork_plot + plot_annotation(title = str_c('Cluster similarity using threshold of ', threshold),
                                 subtitle = 'Rows human, columns mouse, scale correlation')
```




<!-- I think I need to work out the ggplot slice series functions to make this more useful.  -->

<!-- What is going on with cluster 2 in the 2-cluster solution.  -->

<!-- ```{r} -->
<!-- demofile <- '../data/human/registration/DBM_input_demo_passedqc.csv' -->
<!-- demographics <- read_csv(demofile) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- demographics <- demographics %>%  -->
<!--   mutate(ID = str_remove(Extract_ID, '.extracted.mnc')) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- human_cluster_ids <- human_cluster_ids %>%  -->
<!--   mutate(File = ID, -->
<!--          ID = str_remove(File, '.extracted.*.mnc$')) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- human_cluster_demographics <- human_cluster_ids %>%  -->
<!--   left_join(demographics, by = 'ID') -->
<!-- ``` -->

<!-- ```{r} -->
<!-- human_cluster_demographics %>%  -->
<!--   filter(Group2 == 2) %>%  -->
<!--   select(ID, Dataset, Scanner, Age, DX, Rating_Motion) %>%  -->
<!--   arrange(Dataset, Scanner, Age) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- human_cluster_demographics %>%  -->
<!--   select(ID, Group2, Dataset, Scanner) %>%  -->
<!--   group_by(Group2, Dataset, Scanner) %>%  -->
<!--   summarise(count = n()) %>%  -->
<!--   arrange(desc(Group2)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ggplot(human_cluster_demographics,  -->
<!--        aes(x = Age, -->
<!--            fill = factor(Group2))) +  -->
<!--   geom_histogram(binwidth = 0.8)  -->
<!-- ``` -->

<!-- I don't know what's going on here. The fact that they're all the same age is suspicious. -->
